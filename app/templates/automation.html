{% extends "base.html" %}

{% block title %}{% if automation %}{{ automation.name }}{% else %}New Automation{% endif %} - Webhook Manager{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <a href="{{ url_for('dashboard.dashboard') }}" class="btn btn-link">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
                <h4 class="mb-0 ms-3">{% if automation %}{{ automation.name }}{% else %}New Automation{% endif %}</h4>
            </div>
            {% if automation %}
            <button class="btn btn-secondary" id="editAutomationBtn">
                Edit
            </button>
            {% endif %}
        </div>
        <div class="card-body">
            {% if not automation %}
            <form id="createAutomationForm">
                <div class="mb-3">
                    <label for="automationName" class="form-label">Automation Name</label>
                    <input type="text" class="form-control" id="automationName" required>
                </div>
                <div class="text-end">
                    <a href="{{ url_for('dashboard.dashboard') }}" class="btn btn-secondary me-2">Cancel</a>
                    <button type="submit" class="btn btn-primary">Create</button>
                </div>
            </form>
            {% else %}
            <div id="automationDetails">
                <h5>Webhook URL</h5>
                <div class="input-group mb-4">
                    <input type="text" 
                           class="form-control font-monospace" 
                           value="{{ request.url_root }}webhook?automation_id={{ automation.automation_id }}" 
                           readonly>
                    <button class="btn btn-outline-secondary copy-url" type="button">Copy</button>
                </div>

                <h5>Template</h5>
                <div class="position-relative bg-light rounded mb-4">
                    <pre class="p-3 mb-0"><code class="language-json">{% filter indent(width=4) %}
{
    "action": "{{strategy.order.action}}",
    "ticker": "{{ticker}}",
    "order_size": "100%",
    "position_size": "{{strategy.position_size}}",
    "schema": "2",
    "timestamp": "{{time}}"
}{% endfilter %}</code></pre>
                    <button class="btn btn-sm btn-secondary position-absolute top-0 end-0 m-2 copy-template">
                        Copy
                    </button>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% if automation %}
<!-- Edit Modal -->
<div class="modal fade" id="editAutomationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Automation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editAutomationForm">
                    <div class="mb-3">
                        <label for="editAutomationName" class="form-label">Automation Name</label>
                        <input type="text" class="form-control" id="editAutomationName" required>
                        <input type="hidden" id="editAutomationId" value="{{ automation.automation_id }}">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="deleteAutomation">Delete Automation</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveAutomationChanges">Save Changes</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize copy buttons
    document.querySelectorAll('.copy-url, .copy-template').forEach(button => {
        button.addEventListener('click', function() {
            const isUrl = this.classList.contains('copy-url');
            const textToCopy = isUrl ? 
                this.previousElementSibling.value :
                this.closest('.position-relative').querySelector('pre code').textContent;

            navigator.clipboard.writeText(textToCopy).then(() => {
                button.textContent = 'Copied!';
                setTimeout(() => button.textContent = 'Copy', 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy to clipboard');
            });
        });
    });

    // Create Automation Form
    const createForm = document.getElementById('createAutomationForm');
    if (createForm) {
        createForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('automationName').value.trim();
            
            if (!name) {
                alert('Please enter an automation name');
                return;
            }
    
            fetch('/automation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name: name })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) throw new Error(data.error);
                window.location.href = `/automation/${data.automation_id}`;
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error creating automation: ' + error.message);
            });
        });
    }

    // Edit Automation
    const editBtn = document.getElementById('editAutomationBtn');
    if (editBtn) {
        editBtn.addEventListener('click', function() {
            const modal = new bootstrap.Modal(document.getElementById('editAutomationModal'));
            const nameInput = document.getElementById('editAutomationName');
            nameInput.value = document.querySelector('.card-header h4').textContent.trim();
            modal.show();
        });
    }

    // Save Changes
    const saveChangesBtn = document.getElementById('saveAutomationChanges');
    if (saveChangesBtn) {
        saveChangesBtn.addEventListener('click', function() {
            const name = document.getElementById('editAutomationName').value.trim();
            const id = document.getElementById('editAutomationId').value;
            
            if (!name) {
                alert('Please enter an automation name');
                return;
            }

            fetch(`/automation/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name: name })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) throw new Error(data.error);
                document.querySelector('.card-header h4').textContent = name;
                const modal = bootstrap.Modal.getInstance(document.getElementById('editAutomationModal'));
                modal.hide();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating automation: ' + error.message);
            });
        });
    }

    // Delete Automation
    const deleteBtn = document.getElementById('deleteAutomation');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to delete this automation? This action cannot be undone.')) {
                const id = document.getElementById('editAutomationId').value;
                
                fetch(`/automation/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) throw new Error(data.error);
                    window.location.href = '/dashboard';
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting automation: ' + error.message);
                });
            }
        });
    }
});
</script>
{% endblock %}

# 3. Modified dashboard.html template (relevant parts)
<tr class="automation-row {% if not automation.is_active %}text-muted{% endif %}" 
    data-automation-id="{{ automation.automation_id }}">
    <td>
        <a href="{{ url_for('automation.view_automation', automation_id=automation.automation_id) }}" 
           class="text-decoration-none text-dark">
            {{ automation.name }}
        </a>
    </td>
    <td class="text-end">
        <a href="{{ url_for('automation.view_automation', automation_id=automation.automation_id) }}" 
           class="btn btn-sm btn-secondary">
            Edit
        </a>
        <button class="btn btn-sm status-button {% if automation.is_active %}btn-success{% else %}btn-danger{% endif %}" 
                data-automation-id="{{ automation.automation_id }}"
                data-is-active="{{ automation.is_active | tojson }}">
            {{ "Active" if automation.is_active else "Inactive" }}
        </button>
    </td>
</tr>

# 4. Create New Automation button in dashboard.html
<div class="card-header d-flex justify-content-between align-items-center">
    <h4 class="mb-0">Automations</h4>
    <a href="{{ url_for('automation.new_automation') }}" class="btn btn-secondary">Create New Automation</a>
</div>