{% extends "base.html" %}

{% block title %}{% if automation %}{{ automation.name }}{% else %}New Automation{% endif %} - Webhook Manager{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/trading-pair-selector.css') }}">
<link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
{% endblock %}

{% block content %}
<div class="container mt-4" data-automation-id="{{ automation.automation_id if automation }}">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <a href="{{ url_for('dashboard.dashboard') }}" class="text-decoration-none text-secondary">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
        {% if automation %}
        <button class="btn btn-danger" id="deleteAutomationBtn">
            Delete Automation
        </button>
        {% endif %}
    </div>
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            {% if automation %}
            <div class="d-flex align-items-center" id="titleContainer">
                <h4 class="mb-0" id="automationTitle">{{ automation.name }}</h4>
                <input type="text" 
                       class="form-control ms-2 d-none" 
                       id="automationTitleInput" 
                       value="{{ automation.name }}" 
                       style="width: auto;">
                <button class="btn btn-link p-0 ms-2 text-secondary opacity-50 hover-opacity-100" 
                        id="editTitleBtn" 
                        style="transition: opacity 0.2s;">
                    <i class="fas fa-pencil-alt fa-sm"></i>
                </button>
                <button class="btn btn-link p-0 ms-2 text-secondary d-none" id="saveTitleBtn">
                    <i class="fas fa-save"></i>
                </button>
            </div>
            {% else %}
            <h4 class="mb-0">New Automation</h4>
            {% endif %}
        </div>
        <div class="card-body">
            {% if not automation %}
            <!-- Create New Automation Form -->
            <form id="createAutomationForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="mb-3">
                    <label for="automationName" class="form-label">Automation Name</label>
                    <input type="text" class="form-control" id="automationName" required>
                </div>
                <div class="text-end">
                    <a href="{{ url_for('dashboard.dashboard') }}" class="btn btn-secondary me-2">Cancel</a>
                    <button type="submit" class="btn btn-primary">Create</button>
                </div>
            </form>
            {% else %}
            <div id="automationDetails">
                <!-- Portfolio Section -->
                {% if portfolio %}
                <!-- Portfolio is already connected -->
                <div class="card mb-4">
                    <div class="card-header bg-success bg-opacity-10">
                        <h5 class="mb-0">Connected Portfolio</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="mb-1"><strong>Portfolio:</strong> {{ portfolio.name }}</p>
                                <p class="mb-1"><strong>Exchange:</strong> {{ portfolio.exchange|capitalize }}</p>
                                {% if portfolio.has_valid_credentials == false or portfolio_status == 'invalid' %}
                                <div class="alert alert-warning mt-2">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>API Keys Missing or Invalid:</strong> Your Coinbase API keys for this portfolio are no longer valid.
                                </div>
                                {% elif portfolio.value is defined and portfolio.value is not none %}
                                <p class="mb-0">
                                    <strong>Value:</strong> 
                                    <span class="text-success">${{ "%.2f"|format(portfolio.value) }}</span>
                                </p>
                                {% endif %}
                            </div>
                            <form method="POST" action="{{ url_for('automation.disconnect_portfolio', automation_id=automation.automation_id) }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-outline-danger btn-sm" 
                                        onclick="return confirm('Are you sure you want to disconnect this portfolio?');">
                                    Disconnect Portfolio
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                
                {% else %}
                <!-- No portfolio connected yet -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Connect a Portfolio</h5>
                    </div>
                    <div class="card-body">
                        <!-- Step 1: Portfolio Selection Section -->
                        <div id="portfolio-selection-section" {% if show_api_form %}class="d-none"{% endif %}>
                            <p class="text-muted mb-3">
                                Connect your Coinbase portfolio to this automation to execute trades.
                            </p>
                            
                            {% if portfolios %}
                            <form id="select-portfolio-form" method="POST" action="{{ url_for('automation.select_portfolio', automation_id=automation.automation_id) }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <div class="mb-3">
                                    <label for="portfolio_id" class="form-label">Select a portfolio:</label>
                                    <select class="form-select" id="portfolio_id" name="portfolio_id" required>
                                        <option value="">-- Select a portfolio --</option>
                                        {% for portfolio in portfolios %}
                                            {% if portfolio.name.lower() != 'default' %}
                                                <option value="{{ portfolio.id }}">{{ portfolio.name }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <button type="button" id="createPortfolioBtn" class="btn btn-outline-secondary">
                                        <i class="fas fa-plus-circle me-1"></i> Create New Portfolio
                                    </button>
                                    <div>
                                        <button type="button" id="refreshPortfoliosBtn" class="btn btn-outline-primary me-2">
                                            <i class="fas fa-sync-alt me-1"></i> Refresh List
                                        </button>
                                        <button type="submit" class="btn btn-primary">Next</button>
                                    </div>
                                </div>
                            </form>
                            {% else %}
                            <div class="alert alert-warning">
                                <h6>No portfolios found</h6>
                                <p>We couldn't find any portfolios associated with your Coinbase account. This could be because:</p>
                                <ul>
                                    <li>You haven't set up your default Coinbase API credentials yet</li>
                                    <li>Your API credentials don't have permission to view portfolios</li>
                                    <li>You don't have any portfolios set up on Coinbase</li>
                                </ul>
                                <div class="mt-3">
                                    <a href="{{ url_for('dashboard.settings') }}" class="btn btn-primary me-2">Setup API Credentials</a>
                                    <button type="button" id="refreshPortfoliosBtn" class="btn btn-outline-primary">
                                        <i class="fas fa-sync-alt me-1"></i> Refresh List
                                    </button>
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- The portfolio instructions alert will be inserted here dynamically -->
                        </div>

                        <!-- Updated Modal for Portfolio Creation -->
                        <div class="modal fade" id="createPortfolioModal" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Create New Portfolio</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form id="createPortfolioForm">
                                            <div class="mb-3">
                                                <label for="portfolioName" class="form-label">Portfolio Name</label>
                                                <input type="text" class="form-control" id="portfolioName" required>
                                                <div class="form-text">Choose a name for your trading portfolio</div>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="submit" form="createPortfolioForm" class="btn btn-primary">Create</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- API Key Form Section -->
                        <div id="api-key-form-section" {% if not show_api_form %}class="d-none"{% endif %}>
                            <h5 class="mb-3">Connect API Keys for {{ selected_portfolio.name }}</h5>
                            
                            <div class="alert alert-info mb-4">
                                <h6 class="fw-bold">How to get your API Keys:</h6>
                                <ol>
                                    <li>Go to <a href="https://www.coinbase.com/settings/api" target="_blank">https://www.coinbase.com/settings/api</a></li>
                                    <li>Click "New API Key"</li>
                                    <li>Give the API key a nickname (e.g., "{{ automation.name }}")</li>
                                    <li>Under Portfolio, select "{{ selected_portfolio.name }}"</li>
                                    <li>Check the ✅ View (read-only), and the ✅ Trade (execute trades on your behalf) boxes</li>
                                    <li>Set an IP whitelist if desired (optional)</li>
                                    <li>Click "Create API Key" and you'll see your API Key and API Secret</li>
                                    <li>Copy and paste both values below (you won't be able to see the API Secret again)</li>
                                </ol>
                            </div>
                            
                            <form method="POST" action="{{ url_for('automation.save_api_keys', automation_id=automation.automation_id) }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <input type="hidden" name="portfolio_id" value="{{ selected_portfolio.id }}">
                                <input type="hidden" name="portfolio_name" value="{{ selected_portfolio.name }}">
                                
                                <div class="mb-3">
                                    <label for="api_key" class="form-label">API Key:</label>
                                    <input type="text" class="form-control" id="api_key" name="api_key" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="api_secret" class="form-label">API Secret:</label>
                                    <input type="password" class="form-control" id="api_secret" name="api_secret" required>
                                </div>
                                
                                <div class="d-flex justify-content-between">
                                    <button type="button" id="backToPortfolioSelection" class="btn btn-secondary">Back</button>
                                    <button type="submit" class="btn btn-success">Save and Connect</button>
                                </div>
                            </form>
                        </div>
                    </div>

                </div>
                {% endif %}
                <!-- Trading Pair Section -->
                <div class="card mb-4">    
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Trading Pair</h5>
                        {% if automation and automation.trading_pair %}
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="editPairBtn">
                                <i class="fas fa-pencil-alt"></i> Edit
                            </button>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        <div id="trading-pair-selection">
                            <!-- View Mode -->
                            {% if automation and automation.trading_pair %}
                                <div class="view-mode" id="pairViewMode">
                                    <div class="selected-pair">{{ automation.trading_pair }}</div>
                                </div>
                            {% endif %}

                            <!-- Edit Mode - Show for new automations or when editing -->
                            <div class="edit-mode {% if automation and automation.trading_pair %}d-none{% endif %}" id="pairEditMode">
                                <div class="trading-pair-select" id="trading-pair-select">
                                    <input type="text" class="form-control" id="trading_pair" 
                                        placeholder="Start typing (e.g. BTC-USD, ETH-USDT)" 
                                        value="{{ automation.trading_pair or '' }}" autocomplete="off">
                                    <input type="hidden" id="trading_pair_id" name="trading_pair_id" value="{{ automation.trading_pair or '' }}">
                                </div>
                                
                                <!-- Always show these buttons in edit mode -->
                                <div class="mt-3">
                                    {% if automation and automation.trading_pair %}
                                        <button type="button" class="btn btn-secondary" id="cancelPairEdit">Cancel</button>
                                    {% endif %}
                                    <button type="button" class="btn btn-primary ms-2" id="savePairBtn">Save</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TradingView Setup Section -->
                <div class="card mb-4" id="tradingview-setup-section" {% if not automation.trading_pair %}style="display: none;"{% endif %}>    
                    <div class="card-header">
                        <h5 class="mb-0">TradingView Alert Setup</h5>
                    </div>
                    <div class="card-body">
                        <h5>Webhook URL</h5>
                        <div class="input-group mb-4">
                            <input type="text" 
                                class="form-control font-monospace" 
                                value="{{ webhook_url }}" 
                                readonly>
                            <button class="btn btn-outline-secondary copy-url" type="button">Copy</button>
                        </div>

                        <h5>Template</h5>
                        <div class="position-relative bg-light rounded mb-4">
                            <pre class="p-3 mb-0"><code class="language-json" id="webhook-template-code">{% raw %}{
    "action": "{{strategy.order.action}}",
    "ticker": "{% endraw %}{{ automation.trading_pair }}{% raw %}",
    "timestamp": "{{time}}",
    "message": "TradingView order"
}{% endraw %}</code></pre>
                            <button class="btn btn-sm btn-secondary position-absolute top-0 end-0 m-2 copy-template">
                                Copy
                            </button>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <span>Copy this template into your TradingView alert's "Message" field. The action will be automatically filled with "buy" or "sell" based on your TradingView strategy.</span>
                        </div>
                    </div>
                </div>

                <!-- No Trading Pair Alert -->
                <div class="alert alert-warning" id="no-trading-pair-alert" {% if automation.trading_pair %}style="display: none;"{% endif %}>
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Trading Pair Required:</strong> Please select a trading pair above to complete your automation setup and view the webhook details.
                </div>
            {% endif %}
        </div>

        {% if automation %}
        <div id="automation-logs"></div>
        {% endif %}
        
    </div>


</div>
{% endblock %}

{% block scripts %}
{{ super() }}

<script src="{{ url_for('static', filename='js/trading-pair-selector.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const automationId = document.querySelector('[data-automation-id]')?.dataset.automationId || 
                            '{{ automation.automation_id if automation }}';
    
    // Get CSRF token - make it available in a broader scope
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

    // Add title editing functionality
    const editTitleBtn = document.getElementById('editTitleBtn');
    const saveTitleBtn = document.getElementById('saveTitleBtn');
    const automationTitle = document.getElementById('automationTitle');
    const automationTitleInput = document.getElementById('automationTitleInput');
    
    if (editTitleBtn && saveTitleBtn && automationTitle && automationTitleInput) {
        // Handle edit button click
        editTitleBtn.addEventListener('click', function() {
            // Show input and save button
            automationTitle.classList.add('d-none');
            automationTitleInput.classList.remove('d-none');
            editTitleBtn.classList.add('d-none');
            saveTitleBtn.classList.remove('d-none');
            
            // Focus the input
            automationTitleInput.focus();
        });
        
        // Handle save button click
        saveTitleBtn.addEventListener('click', function() {
            const newTitle = automationTitleInput.value.trim();
            
            // Don't save empty titles
            if (!newTitle) {
                alert('Please enter a title');
                return;
            }
            
            // Save via API
            fetch(`/automation/${automationId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ name: newTitle })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to update title');
                }
                return response.json();
            })
            .then(data => {
                // Update displayed title
                automationTitle.textContent = newTitle;
                
                // Switch back to view mode
                automationTitle.classList.remove('d-none');
                automationTitleInput.classList.add('d-none');
                editTitleBtn.classList.remove('d-none');
                saveTitleBtn.classList.add('d-none');
            })
            .catch(error => {
                console.error('Error updating title:', error);
                alert('Error updating title: ' + error.message);
            });
        });
        
        // Also save on Enter key
        automationTitleInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                saveTitleBtn.click();
            }
        });
    }
    
    // Cache DOM elements for portfolio management
    const createPortfolioBtn = document.getElementById('createPortfolioBtn');
    const portfolioSelectionSection = document.getElementById('portfolio-selection-section');
    const refreshPortfoliosBtn = document.getElementById('refreshPortfoliosBtn');
    const createPortfolioModal = document.getElementById('createPortfolioModal');
    const createPortfolioForm = document.getElementById('createPortfolioForm');
    const deleteAutomationBtn = document.getElementById('deleteAutomationBtn');

    // Handler for Delete Automation button
    if (deleteAutomationBtn && automationId) {
        console.log('Adding delete automation button handler');
        deleteAutomationBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to delete this automation? This action cannot be undone.')) {
                fetch(`/automation/${automationId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to delete automation');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        window.location.href = '/dashboard';
                    } else if (data.error) {
                        throw new Error(data.error);
                    }
                })
                .catch(error => {
                    console.error('Error deleting automation:', error);
                    alert('Error deleting automation: ' + error.message);
                });
            }
        });
    }
    
    // Create automation form handler
    const createForm = document.getElementById('createAutomationForm');
    if (createForm) {
        console.log('Initializing create automation form handler');
        createForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const automationName = document.getElementById('automationName').value.trim();
            if (!automationName) {
                alert('Please enter an automation name');
                return;
            }
            
            // Make API request to create automation
            fetch('/automation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ name: automationName })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Server responded with an error');
                }
                return response.json();
            })
            .then(data => {
                console.log('Automation created:', data);
                // Redirect to the new automation page
                window.location.href = `/automation/${data.automation_id}`;
            })
            .catch(error => {
                console.error('Error creating automation:', error);
                alert('Error creating automation: ' + error.message);
            });
        });
    }
    
    // Initialize portfolio management if elements exist
    if (portfolioSelectionSection) {
        // Refresh button handler
        if (refreshPortfoliosBtn) {
            refreshPortfoliosBtn.addEventListener('click', function() {
                window.location.reload();
            });
        }
        
        // Create Portfolio button handler - Direct approach without using modal
        if (createPortfolioBtn) {
            createPortfolioBtn.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Simple approach: Ask for the name directly with prompt
                const portfolioName = prompt('Enter new portfolio name:');
                if (!portfolioName || portfolioName.trim() === '') {
                    return;
                }
                
                fetch(`/automation/${automationId}/create-portfolio`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ name: portfolioName.trim() })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    if (data.needs_manual_setup) {
                        if (confirm('You need to create a portfolio manually on Coinbase. Would you like to open Coinbase now?')) {
                            window.open('https://www.coinbase.com/advanced-portfolio', '_blank');
                        }
                        return;
                    }
                    
                    if (data.success) {
                        const select = document.getElementById('portfolio_id');
                        if (select) {
                            const option = new Option(data.portfolio.name, data.portfolio.id);
                            select.add(option);
                            select.value = data.portfolio.id;
                        }
                        
                        alert(`Portfolio "${data.portfolio.name}" created successfully!`);
                    }
                })
                .catch(error => {
                    console.error('Error creating portfolio:', error);
                    alert('Error creating portfolio: ' + error.message);
                });
            });
        }
        
        // Setup portfolio form if it exists
        if (createPortfolioForm) {
            createPortfolioForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const portfolioName = document.getElementById('portfolioName').value.trim();
                if (!portfolioName) {
                    alert('Please enter a portfolio name');
                    return;
                }
                
                try {
                    const response = await fetch(`/automation/${automationId}/create-portfolio`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({ name: portfolioName })
                    });
                    
                    const data = await response.json();
                    
                    if (data.error) throw new Error(data.error);
                    
                    if (data.needs_manual_setup) {
                        if (confirm('You need to create a portfolio manually on Coinbase. Would you like to open Coinbase now?')) {
                            window.open('https://www.coinbase.com/advanced-portfolio', '_blank');
                        }
                        return;
                    }
                    
                    if (data.success) {
                        // Try to hide the modal
                        try {
                            if (createPortfolioModal && typeof bootstrap !== 'undefined') {
                                const modal = bootstrap.Modal.getInstance(createPortfolioModal);
                                if (modal) modal.hide();
                            }
                        } catch (error) {
                            console.warn('Could not close modal:', error);
                        }
                        
                        const select = document.getElementById('portfolio_id');
                        if (select) {
                            const option = new Option(data.portfolio.name, data.portfolio.id);
                            select.add(option);
                            select.value = data.portfolio.id;
                        }
                        
                        alert(`Portfolio "${data.portfolio.name}" created successfully!`);
                    }
                } catch (error) {
                    console.error('Error creating portfolio:', error);
                    alert('Error creating portfolio: ' + error.message);
                }
            });
        }
        
        // Check trading credentials
        checkTradingCredentials();
    }

    // Portfolio management functions
    async function checkTradingCredentials() {
        if (!automationId) return;
        
        try {
            const response = await fetch(`/automation/${automationId}/check-trading-credentials`, {
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            });
            
            if (!response.ok) {
                throw new Error(`Server returned ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Credential check response:', data);
            
            const hasPortfolios = checkForNonDefaultPortfolios();
            
            if (data.needs_manual_setup) {
                if (createPortfolioBtn) createPortfolioBtn.style.display = 'none';
                showPortfolioInstructions(data.message, hasPortfolios);
            } else {
                if (createPortfolioBtn) {
                    createPortfolioBtn.style.display = 'inline-block';
                }
            }
        } catch (error) {
            console.error('Error checking trading credentials:', error);
        }
    }

    function checkForNonDefaultPortfolios() {
        const portfolioSelect = document.getElementById('portfolio_id');
        if (!portfolioSelect) return false;
        
        let nonDefaultOptions = 0;
        for (let i = 0; i < portfolioSelect.options.length; i++) {
            const option = portfolioSelect.options[i];
            if (option.value && option.text.toLowerCase() !== 'default') {
                nonDefaultOptions++;
            }
        }
        return nonDefaultOptions > 0;
    }

    function showPortfolioInstructions(message, hasPortfolios) {
        if (!portfolioSelectionSection) return;
        
        const existingAlerts = document.querySelectorAll('.portfolio-instructions-alert');
        existingAlerts.forEach(alert => alert.remove());
        
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-info portfolio-instructions-alert mb-3';
        alertDiv.innerHTML = `
            <h5 class="alert-heading">${hasPortfolios ? 'Pick a portfolio or create a new one' : 'Create a Portfolio'}</h5>
            <ol>
                <li>Go to <a href="https://www.coinbase.com/advanced-portfolio" target="_blank">https://www.coinbase.com/advanced-portfolio</a></li>
                <li>Click "New Portfolio" and create your portfolio</li>
                <li>Return here, refresh the list, and select your new portfolio</li>
            </ol>
        `;
        
        portfolioSelectionSection.insertBefore(alertDiv, portfolioSelectionSection.firstChild);
    }
    
    // Set up copy buttons for webhook URL and template
    const copyUrlBtn = document.querySelector('.copy-url');
    if (copyUrlBtn) {
        copyUrlBtn.addEventListener('click', function() {
            const urlInput = this.previousElementSibling;
            // Use the value property for input elements
            copyToClipboard(urlInput.value, this);
        });
    }

    // Copy template button
    const copyTemplateBtn = document.querySelector('.copy-template');
    if (copyTemplateBtn) {
        copyTemplateBtn.addEventListener('click', function() {
            const templateCode = document.getElementById('webhook-template-code');
            // Use textContent for code elements
            copyToClipboard(templateCode.textContent, this);
        });
    }
    
    // Simplified clipboard function that always uses the fallback method in development
    function copyToClipboard(text, button) {
        // Create temporary textarea
        const textArea = document.createElement('textarea');
        textArea.value = text;
        
        // Make it invisible but keep it in the document flow for selection
        textArea.style.position = 'fixed';
        textArea.style.opacity = '0';
        textArea.style.left = '0';
        textArea.style.top = '0';
        
        document.body.appendChild(textArea);
        textArea.select();
        
        let success = false;
        try {
            // Execute the copy command
            success = document.execCommand('copy');
        } catch (err) {
            console.error('Copy command failed:', err);
        }
        
        // Clean up
        document.body.removeChild(textArea);
        
        // Show feedback
        const originalText = button.textContent;
        const isOutlineBtn = button.classList.contains('btn-outline-secondary');
        
        if (success) {
            button.textContent = 'Copied!';
            button.classList.add('btn-success');
            
            if (isOutlineBtn) {
                button.classList.remove('btn-outline-secondary');
            } else {
                button.classList.remove('btn-secondary');
            }
            
            // Reset after 2 seconds
            setTimeout(() => {
                button.textContent = originalText;
                button.classList.remove('btn-success');
                if (isOutlineBtn) {
                    button.classList.add('btn-outline-secondary');
                } else {
                    button.classList.add('btn-secondary');
                }
            }, 2000);
        } else {
            button.textContent = 'Copy failed';
            setTimeout(() => {
                button.textContent = originalText;
            }, 2000);
        }
    }
});
</script>

{% if automation %}
    <script type="text/babel">
        // AutomationLogs component with support for displaying order details and API responses
        const AutomationLogs = () => {
            const [logs, setLogs] = React.useState([]);
            const [isLoading, setIsLoading] = React.useState(false);
            const [error, setError] = React.useState(null);
            const [expandedRows, setExpandedRows] = React.useState(new Set());
            const [pagination, setPagination] = React.useState({
                page: 1,
                per_page: 20,
                total: 0,
                pages: 0,
                has_next: false,
                has_prev: false
            });

            const fetchLogs = async (page = 1, per_page = 20) => {
                setIsLoading(true);
                setError(null);
                try {
                    const response = await fetch(`/automation/{{ automation.automation_id }}/logs?page=${page}&per_page=${per_page}`);
                    if (!response.ok) {
                        throw new Error('Failed to fetch logs');
                    }
                    const data = await response.json();
                    console.log("Fetched logs:", data.logs); // Debug: view full log data
                    setLogs(data.logs);
                    setPagination(data.pagination);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setIsLoading(false);
                }
            };

            const changePage = (newPage) => {
                // Clear expanded rows when changing pages
                setExpandedRows(new Set());
                setPagination(prev => ({
                    ...prev,
                    page: newPage
                }));
            };

            const changePerPage = (newPerPage) => {
                setExpandedRows(new Set());
                setPagination(prev => ({
                    ...prev,
                    per_page: newPerPage,
                    page: 1
                }));
            };

            const toggleRow = (timestamp) => {
                setExpandedRows(prev => {
                    const next = new Set(prev);
                    if (next.has(timestamp)) {
                        next.delete(timestamp);
                    } else {
                        next.add(timestamp);
                    }
                    return next;
                });
            };
            
            // Parse JSON strings if needed
            const parseJsonField = (field) => {
                if (!field) return null;
                if (typeof field === 'object') return field;
                
                try {
                    return JSON.parse(field);
                } catch (e) {
                    return field; // Return as is if not valid JSON
                }
            };
            
            React.useEffect(() => {
                fetchLogs(pagination.page, pagination.per_page);
            }, [pagination.page, pagination.per_page]);

            return (
                <div className="mt-4">
                    <div className="card">
                        <div className="card-header d-flex justify-content-between align-items-center">
                            <h5 className="mb-0">Webhook Logs</h5>
                            <button 
                                className="btn btn-secondary btn-sm" 
                                onClick={() => fetchLogs(pagination.page, pagination.per_page)}
                                disabled={isLoading}
                                title="Refresh logs"
                            >
                                {isLoading ? (
                                    <span className="spinner-border spinner-border-sm"></span>
                                ) : (
                                    <i className="fas fa-sync"></i>
                                )}
                            </button>
                        </div>
                        <div className="card-body p-0">
                            <div className="table-responsive">
                                <table className="table mb-0">
                                    <thead>
                                        <tr>
                                            <th className="w-200 text-nowrap">Timestamp (UTC)</th>
                                            <th>Information</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {logs.length === 0 ? (
                                            <tr>
                                                <td colSpan="2" className="text-center py-4">
                                                    No webhook logs found for this automation.
                                                </td>
                                            </tr>
                                        ) : (
                                            logs.map((log) => (
                                                <tr 
                                                    key={log.timestamp}
                                                    onClick={() => toggleRow(log.timestamp)}
                                                    className="webhook-log-row cursor-pointer"
                                                >
                                                    <td className="text-nowrap w-200">{new Date(log.timestamp).toLocaleString()}</td>
                                                    <td>
                                                        {/* Basic Info (Always Visible) */}
                                                        <div className="d-flex justify-content-between">
                                                            <div>
                                                                <span className={`badge ${log.action?.toLowerCase() === 'buy' ? 'bg-success' : 'bg-danger'} me-2`}>
                                                                    {/* Capitalize action regardless of source */}
                                                                    {log.action ? log.action.toUpperCase() : 'UNKNOWN'}
                                                                </span>
                                                                <strong>{log.ticker || ''}</strong>
                                                                {log.message && <span className="ms-2 text-muted">{log.message}</span>}
                                                            </div>
                                                            <div>
                                                                {log.status && (
                                                                    <span className={`badge ${
                                                                        log.status.toLowerCase() === 'success' ? 'bg-success' : 
                                                                        log.status.toLowerCase() === 'error' ? 'bg-danger' :
                                                                        log.status.toLowerCase() === 'filled' ? 'bg-primary' : 'bg-secondary'
                                                                    }`}>
                                                                        {/* Title case the status */}
                                                                        {log.status.charAt(0).toUpperCase() + log.status.slice(1).toLowerCase()}
                                                                    </span>
                                                                )}
                                                            </div>
                                                        </div>
                                                        
                                                        {/* Expanded Details */}
                                                        {expandedRows.has(log.timestamp) && (
                                                            <div className="mt-3">
                                                                {/* Payload Section */}
                                                                <div className="mb-3">
                                                                    <h6 className="mb-2">Webhook Payload:</h6>
                                                                    <pre className="bg-light p-2 rounded small mb-0">
                                                                        {JSON.stringify(log.payload, null, 2)}
                                                                    </pre>
                                                                </div>
                                                                
                                                                {/* Order Information Section */}
                                                                {log.order_id && (
                                                                    <div className="mb-0 p-2 bg-light border rounded">
                                                                        <h6 className="mb-2">Execution Details:</h6>
                                                                        <table className="table table-sm mb-0">
                                                                            <tbody>
                                                                                <tr>
                                                                                    <th className="w-25">Order ID:</th>
                                                                                    <td>{log.order_id}</td>
                                                                                </tr>
                                                                                <tr>
                                                                                    <th>Status:</th>
                                                                                    <td>{log.status || 'Unknown'}</td>
                                                                                </tr>
                                                                                <tr>
                                                                                    <th>Client Order ID:</th>
                                                                                    <td>{log.client_order_id}</td>
                                                                                </tr>
                                                                                {log.raw_response && (
                                                                                    <tr>
                                                                                        <th>Exchange Response:</th>
                                                                                        <td>
                                                                                            <pre className="small mb-0">
                                                                                                {typeof log.raw_response === 'string' 
                                                                                                    ? log.raw_response 
                                                                                                    : JSON.stringify(parseJsonField(log.raw_response), null, 2)}
                                                                                            </pre>
                                                                                        </td>
                                                                                    </tr>
                                                                                )}
                                                                            </tbody>
                                                                        </table>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        )}
                                                    </td>
                                                </tr>
                                            ))
                                        )}
                                    </tbody>
                                </table>
                            </div>
                            {error && (
                                <div className="alert alert-danger m-3" role="alert">
                                    {error}
                                </div>
                            )}
                        </div>
                        <div className="card-footer d-flex justify-content-between align-items-center">
                            <div>
                                <span className="me-2">Show</span>
                                <select 
                                    className="form-select form-select-sm d-inline-block w-auto"
                                    value={pagination.per_page}
                                    onChange={(e) => changePerPage(parseInt(e.target.value))}
                                >
                                    <option value="10">10</option>
                                    <option value="20">20</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                                <span className="ms-2">entries</span>
                            </div>
                            
                            <nav aria-label="Automation logs pagination">
                                <ul className="pagination pagination-sm mb-0">
                                    <li className={`page-item ${!pagination.has_prev ? 'disabled' : ''}`}>
                                        <button className="page-link" onClick={() => changePage(pagination.prev_num)} disabled={!pagination.has_prev}>Previous</button>
                                    </li>
                                    
                                    {pagination.pages <= 7 ? (
                                        [...Array(pagination.pages).keys()].map(i => (
                                            <li key={i+1} className={`page-item ${pagination.page === i+1 ? 'active' : ''}`}>
                                                <button className="page-link" onClick={() => changePage(i+1)}>{i+1}</button>
                                            </li>
                                        ))
                                    ) : (
                                        <>
                                            <li className={`page-item ${pagination.page === 1 ? 'active' : ''}`}>
                                                <button className="page-link" onClick={() => changePage(1)}>1</button>
                                            </li>
                                            
                                            {pagination.page > 3 && <li className="page-item disabled"><span className="page-link">...</span></li>}
                                            
                                            {pagination.page !== 1 && pagination.page !== pagination.pages && (
                                                <li className="page-item active">
                                                    <button className="page-link">{pagination.page}</button>
                                                </li>
                                            )}
                                            
                                            {pagination.page < pagination.pages - 2 && <li className="page-item disabled"><span className="page-link">...</span></li>}
                                            
                                            <li className={`page-item ${pagination.page === pagination.pages ? 'active' : ''}`}>
                                                <button className="page-link" onClick={() => changePage(pagination.pages)}>{pagination.pages}</button>
                                            </li>
                                        </>
                                    )}
                                    
                                    <li className={`page-item ${!pagination.has_next ? 'disabled' : ''}`}>
                                        <button className="page-link" onClick={() => changePage(pagination.next_num)} disabled={!pagination.has_next}>Next</button>
                                    </li>
                                </ul>
                            </nav>
                            
                            <div>
                                Showing {logs.length} of {pagination.total} entries
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Initialize AutomationLogs component
        const container = document.getElementById('automation-logs');
        ReactDOM.render(React.createElement(AutomationLogs), container);
    </script>
{% endif %}

{% endblock %}