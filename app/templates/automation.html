{% extends "base.html" %}

{% block title %}{% if automation %}{{ automation.name }}{% else %}New Automation{% endif %} - Webhook Manager{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/trading-pair-selector.css') }}">
{% endblock %}

{% block content %}
<div class="container mt-4" data-automation-id="{{ automation.automation_id if automation }}">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <a href="{{ url_for('dashboard.dashboard') }}" class="text-decoration-none text-secondary">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
        {% if automation %}
        <button class="btn btn-danger" id="deleteAutomationBtn">
            Delete Automation
        </button>
        {% endif %}
    </div>
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            {% if automation %}
            <div class="d-flex align-items-center" id="titleContainer">
                <h4 class="mb-0" id="automationTitle">{{ automation.name }}</h4>
                <input type="text" 
                       class="form-control ms-2 d-none" 
                       id="automationTitleInput" 
                       value="{{ automation.name }}" 
                       style="width: auto;">
                <button class="btn btn-link p-0 ms-2 text-secondary opacity-50 hover-opacity-100" 
                        id="editTitleBtn" 
                        style="transition: opacity 0.2s;">
                    <i class="fas fa-pencil-alt fa-sm"></i>
                </button>
                <button class="btn btn-link p-0 ms-2 text-secondary d-none" id="saveTitleBtn">
                    <i class="fas fa-save"></i>
                </button>
            </div>
            {% else %}
            <h4 class="mb-0">New Automation</h4>
            {% endif %}
        </div>
        <div class="card-body">
            {% if not automation %}
            <!-- Create New Automation Form -->
            <form id="createAutomationForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="mb-3">
                    <label for="automationName" class="form-label">Automation Name</label>
                    <input type="text" class="form-control" id="automationName" required>
                </div>
                <div class="text-end">
                    <a href="{{ url_for('dashboard.dashboard') }}" class="btn btn-secondary me-2">Cancel</a>
                    <button type="submit" class="btn btn-primary">Create</button>
                </div>
            </form>
            {% else %}
            <div id="automationDetails">
                <!-- Portfolio Section -->
                {% if portfolio %}
                <!-- Portfolio is already connected -->
                <div class="card mb-4">
                    <div class="card-header bg-success bg-opacity-10">
                        <h5 class="mb-0">Connected Portfolio</h5>
                    </div>
                    <!-- Change this section in automation.html -->
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="mb-1"><strong>Portfolio:</strong> {{ portfolio.name }}</p>
                                <p class="mb-1"><strong>Exchange:</strong> {{ portfolio.exchange|capitalize }}</p>
                                {% if portfolio.value is defined and portfolio.value is not none %}
                                    <p class="mb-0">
                                        <strong>Value:</strong> 
                                        <span class="text-success">${{ "%.2f"|format(portfolio.value) }}</span>
                                    </p>
                                {% endif %}
                            </div>
                            <form method="POST" action="{{ url_for('automation.disconnect_portfolio', automation_id=automation.automation_id) }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-outline-danger btn-sm" 
                                        onclick="return confirm('Are you sure you want to disconnect this portfolio?');">
                                    Disconnect Portfolio
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                
                {% else %}
                <!-- No portfolio connected yet -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Connect a Portfolio</h5>
                    </div>
                    <div class="card-body">
                        <!-- Step 1: Portfolio Selection Section -->
                        <div id="portfolio-selection-section" {% if show_api_form %}class="d-none"{% endif %}>
                            <p class="text-muted mb-3">
                                Connect your Coinbase portfolio to this automation to execute trades.
                            </p>
                            
                            {% if portfolios %}
                            <form id="select-portfolio-form" method="POST" action="{{ url_for('automation.select_portfolio', automation_id=automation.automation_id) }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <div class="mb-3">
                                    <label for="portfolio_id" class="form-label">Select a portfolio:</label>
                                    <select class="form-select" id="portfolio_id" name="portfolio_id" required>
                                        <option value="">-- Select a portfolio --</option>
                                        {% for portfolio in portfolios %}
                                            {% if portfolio.name.lower() != 'default' %}
                                                <option value="{{ portfolio.id }}">{{ portfolio.name }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <button type="button" id="createPortfolioBtn" class="btn btn-outline-secondary">
                                        <i class="fas fa-plus-circle me-1"></i> Create New Portfolio
                                    </button>
                                    <div>
                                        <button type="button" id="refreshPortfoliosBtn" class="btn btn-outline-primary me-2">
                                            <i class="fas fa-sync-alt me-1"></i> Refresh List
                                        </button>
                                        <button type="submit" class="btn btn-primary">Next</button>
                                    </div>
                                </div>
                            </form>
                            {% else %}
                            <div class="alert alert-warning">
                                <h6>No portfolios found</h6>
                                <p>We couldn't find any portfolios associated with your Coinbase account. This could be because:</p>
                                <ul>
                                    <li>You haven't set up your default Coinbase API credentials yet</li>
                                    <li>Your API credentials don't have permission to view portfolios</li>
                                    <li>You don't have any portfolios set up on Coinbase</li>
                                </ul>
                                <div class="mt-3">
                                    <a href="{{ url_for('dashboard.settings') }}" class="btn btn-primary me-2">Setup API Credentials</a>
                                    <button type="button" id="refreshPortfoliosBtn" class="btn btn-outline-primary">
                                        <i class="fas fa-sync-alt me-1"></i> Refresh List
                                    </button>
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- The portfolio instructions alert will be inserted here dynamically -->
                        </div>

                        <!-- Updated Modal for Portfolio Creation -->
                        <div class="modal fade" id="createPortfolioModal" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Create New Portfolio</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form id="createPortfolioForm">
                                            <div class="mb-3">
                                                <label for="portfolioName" class="form-label">Portfolio Name</label>
                                                <input type="text" class="form-control" id="portfolioName" required>
                                                <div class="form-text">Choose a name for your trading portfolio</div>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="submit" form="createPortfolioForm" class="btn btn-primary">Create</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- API Key Form Section -->
                        <div id="api-key-form-section" {% if not show_api_form %}class="d-none"{% endif %}>
                            <h5 class="mb-3">Connect API Keys for {{ selected_portfolio.name }}</h5>
                            
                            <div class="alert alert-info mb-4">
                                <h6 class="fw-bold">How to get your API Keys:</h6>
                                <ol>
                                    <li>Go to <a href="https://www.coinbase.com/settings/api" target="_blank">https://www.coinbase.com/settings/api</a></li>
                                    <li>Click "New API Key"</li>
                                    <li>Give the API key a nickname (e.g., "{{ automation.name }}")</li>
                                    <li>Under Portfolio, select "{{ selected_portfolio.name }}"</li>
                                    <li>Check the ✅ View (read-only), and the ✅ Trade (execute trades on your behalf) boxes</li>
                                    <li>Set an IP whitelist if desired (optional)</li>
                                    <li>Click "Create API Key" and you'll see your API Key and API Secret</li>
                                    <li>Copy and paste both values below (you won't be able to see the API Secret again)</li>
                                </ol>
                            </div>
                            
                            <form method="POST" action="{{ url_for('automation.save_api_keys', automation_id=automation.automation_id) }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <input type="hidden" name="portfolio_id" value="{{ selected_portfolio.id }}">
                                <input type="hidden" name="portfolio_name" value="{{ selected_portfolio.name }}">
                                
                                <div class="mb-3">
                                    <label for="api_key" class="form-label">API Key:</label>
                                    <input type="text" class="form-control" id="api_key" name="api_key" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="api_secret" class="form-label">API Secret:</label>
                                    <input type="password" class="form-control" id="api_secret" name="api_secret" required>
                                </div>
                                
                                <div class="d-flex justify-content-between">
                                    <button type="button" id="backToPortfolioSelection" class="btn btn-secondary">Back</button>
                                    <button type="submit" class="btn btn-success">Save and Connect</button>
                                </div>
                            </form>
                        </div>
                    </div>

                </div>
                {% endif %}
                <!-- Trading Pair Section -->
                <div class="card mb-4">    
                    <div class="card-header">
                        <h5 class="mb-0">Trading Pair</h5>
                    </div>
                    <div class="card-body">
                        <div id="trading-pair-selection">
                            <div class="trading-pair-select mb-3" id="trading-pair-select">
                                <input type="text" class="form-control" id="trading_pair" 
                                       placeholder="Start typing (e.g. BTC-USD, ETH-USDT)" 
                                       value="{{ automation.trading_pair or '' }}" autocomplete="off">
                                <input type="hidden" id="trading_pair_id" name="trading_pair_id" value="{{ automation.trading_pair }}">
                            </div>
                            <small class="form-text text-muted">
                                Select the trading pair for this automation. This determines which assets will be traded.
                            </small>
                        </div>
                    </div>
                </div>

                <!-- TradingView Setup Section -->
                <div class="card mb-4" id="tradingview-setup-section" {% if not automation.trading_pair %}style="display: none;"{% endif %}>    
                    <div class="card-header">
                        <h5 class="mb-0">TradingView Alert Setup</h5>
                    </div>
                    <div class="card-body">
                        <h5>Webhook URL</h5>
                        <div class="input-group mb-4">
                            <input type="text" 
                                class="form-control font-monospace" 
                                value="{{ request.url_root }}webhook?automation_id={{ automation.automation_id }}" 
                                readonly>
                            <button class="btn btn-outline-secondary copy-url" type="button">Copy</button>
                        </div>

                        <h5>Template</h5>
                        <div class="position-relative bg-light rounded mb-4">
                            <pre class="p-3 mb-0"><code class="language-json" id="webhook-template-code">{% raw %}{
    "action": "{{strategy.order.action}}",
    "ticker": "{% endraw %}{{ automation.trading_pair }}{% raw %}",
    "timestamp": "{{time}}",
    "message": "TradingView order"
}{% endraw %}</code></pre>
                            <button class="btn btn-sm btn-secondary position-absolute top-0 end-0 m-2 copy-template">
                                Copy
                            </button>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <span>Copy this template into your TradingView alert's "Message" field. The action will be automatically filled with "buy" or "sell" based on your TradingView strategy.</span>
                        </div>
                    </div>
                </div>

                <!-- No Trading Pair Alert -->
                <div class="alert alert-warning" id="no-trading-pair-alert" {% if automation.trading_pair %}style="display: none;"{% endif %}>
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Trading Pair Required:</strong> Please select a trading pair above to complete your automation setup and view the webhook details.
                </div>
            {% endif %}
        </div>

        {% if automation %}
        <div id="automation-logs"></div>
        {% endif %}
        
    </div>


</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const automationId = '{{ automation.automation_id if automation }}';

        // Global variable to store trading pairs data
        window.tradingPairs = [];
    
    // Get elements for the trading pair editor in the portfolio selection form
    const tradingPairSelect = document.getElementById('trading-pair-select');
    const tradingPairInput = document.getElementById('trading_pair');
    const tradingPairResults = document.getElementById('trading-pair-results');
    const tradingPairHidden = document.getElementById('trading_pair');
    
    // For connected portfolio - modal for changing trading pair
    const changeTradingPairBtn = document.getElementById('changeTradingPairBtn');
    const addTradingPairBtn = document.getElementById('addTradingPairBtn');
    const tradingPairModal = document.getElementById('tradingPairModal');
    const modalTradingPairInput = document.getElementById('modal-trading-pair-input');
    const modalTradingPairHidden = document.getElementById('modal-trading_pair');
    const modalTradingPairResults = document.getElementById('modal-trading-pair-results');
    const saveTradingPairBtn = document.getElementById('saveTradingPairBtn');
    
    let tradingPairModalInstance = null;
    
    // Initialize the modal if it exists
    if (tradingPairModal && typeof bootstrap !== 'undefined') {
        tradingPairModalInstance = new bootstrap.Modal(tradingPairModal);
        
        // Set up buttons to open the modal
        if (changeTradingPairBtn) {
            changeTradingPairBtn.addEventListener('click', function() {
                tradingPairModalInstance.show();
            });
        }
        
        if (addTradingPairBtn) {
            addTradingPairBtn.addEventListener('click', function() {
                tradingPairModalInstance.show();
            });
        }
        
        // Set up save button
        if (saveTradingPairBtn) {
            saveTradingPairBtn.addEventListener('click', async function() {
                await saveTradingPair(modalTradingPairHidden.value);
                tradingPairModalInstance.hide();
            });
        }
    }
    
    // Fetch trading pairs from API
    async function fetchTradingPairs() {
        try {
            console.log('Fetching trading pairs...');
            const response = await fetch('/api/coinbase/trading-pairs');
            const data = await response.json();
            
            if (data.success) {
                console.log(`Retrieved ${data.trading_pairs.length} trading pairs`);
                window.tradingPairs = data.trading_pairs;
                return data.trading_pairs;
            } else {
                console.error('Failed to fetch trading pairs:', data.message);
                return [];
            }
        } catch (error) {
            console.error('Error fetching trading pairs:', error);
            return [];
        }
    }
    
    // Save trading pair via API
    async function saveTradingPair(tradingPair) {
        if (!tradingPair) {
            alert('Please select a trading pair');
            return null;
        }
        
        try {
            const response = await fetch(`/automation/${automationId}/trading-pair`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                },
                body: JSON.stringify({ trading_pair: tradingPair })
            });
            
            const data = await response.json();
            if (data.error) {
                throw new Error(data.error);
            }
            
            return data;
        } catch (error) {
            console.error('Error saving trading pair:', error);
            alert(`Error saving trading pair: ${error.message}`);
            return null;
        }
    }
    
    // Filter trading pairs based on search
    function filterTradingPairs(searchTerm, resultsElement) {
        if (!searchTerm) {
            resultsElement.innerHTML = '';
            resultsElement.style.display = 'none';
            return;
        }
        
        if (!window.tradingPairs || !Array.isArray(window.tradingPairs)) {
            console.error('Trading pairs not available:', window.tradingPairs);
            return;
        }

        const term = searchTerm.toUpperCase();
        const filteredPairs = window.tradingPairs
            .filter(pair => {
                if (!pair || !pair.product_id) {
                    console.error('Invalid pair object:', pair);
                    return false;
                }
                return pair.product_id.toUpperCase().includes(term) ||
                    (pair.base_currency && pair.base_currency.toUpperCase().includes(term)) ||
                    (pair.quote_currency && pair.quote_currency.toUpperCase().includes(term));
            })
            .slice(0, 10); // Limit to 10 results
        
        // Display results
        resultsElement.innerHTML = '';
        resultsElement.style.display = filteredPairs.length ? 'block' : 'none';
        
        filteredPairs.forEach(pair => {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.textContent = pair.product_id;
            item.addEventListener('click', () => {
                const input = resultsElement.id === 'trading-pair-results' ? 
                    tradingPairInput : modalTradingPairInput;
                const hidden = resultsElement.id === 'trading-pair-results' ? 
                    tradingPairHidden : modalTradingPairHidden;
                
                input.value = pair.product_id;
                hidden.value = pair.product_id;
                resultsElement.style.display = 'none';
            });
            resultsElement.appendChild(item);
        });
    }

    // Handle trading pair selection and template updates
    const tradingViewSetupSection = document.getElementById('tradingview-setup-section');
    const noTradingPairAlert = document.getElementById('no-trading-pair-alert');
    const webhookTemplateCode = document.getElementById('webhook-template-code');

    // Update the template when a trading pair is selected
    async function updateTradingPair(tradingPair) {
        try {
            const response = await saveTradingPair(tradingPair);
            
            if (response && response.success) {
                // Show the TradingView setup section and hide the alert
                if (tradingViewSetupSection) tradingViewSetupSection.style.display = 'block';
                if (noTradingPairAlert) noTradingPairAlert.style.display = 'none';
                
                // Update the template with the new trading pair
                if (webhookTemplateCode) {
                    const template = webhookTemplateCode.textContent;
                    const updatedTemplate = template.replace(/"ticker": "[^"]*"/, `"ticker": "${tradingPair}"`);
                    webhookTemplateCode.textContent = updatedTemplate;
                }
                
                return true;
            }
            return false;
        } catch (error) {
            console.error('Error updating trading pair:', error);
            return false;
        }
    }
    
    // Set up event listeners for the main form
    if (tradingPairResults) {
        tradingPairResults.addEventListener('click', async function(e) {
            const item = e.target.closest('.dropdown-item');
            if (item) {
                const selectedPair = item.textContent;
                tradingPairInput.value = selectedPair;
                tradingPairHidden.value = selectedPair;
                tradingPairResults.style.display = 'none';
                
                // Update the template without reloading the page
                const success = await updateTradingPair(selectedPair);
                if (!success) {
                    // Only reload if the API call failed
                    window.location.reload();
                }
            }
        });
    }
    
    // Set up event listeners for the modal
    if (modalTradingPairInput && modalTradingPairResults) {
        modalTradingPairInput.addEventListener('input', function() {
            filterTradingPairs(this.value, modalTradingPairResults);
        });
        
        modalTradingPairInput.addEventListener('focus', function() {
            if (this.value) {
                filterTradingPairs(this.value, modalTradingPairResults);
            }
        });
        
        document.addEventListener('click', function(e) {
            if (!document.getElementById('modal-trading-pair-select').contains(e.target)) {
                modalTradingPairResults.style.display = 'none';
            }
        });
    }
    
    // Load trading pairs on page load
    fetchTradingPairs();

    // Initialize copy buttons
    document.querySelectorAll('.copy-url, .copy-template').forEach(button => {
        button.addEventListener('click', function() {
            const isUrl = this.classList.contains('copy-url');
            const textToCopy = isUrl ? 
                this.previousElementSibling.value :
                this.closest('.position-relative').querySelector('pre code').textContent;

            // Try to use the Clipboard API first
            const copyText = () => {
                // Create a temporary textarea element to copy from
                const textarea = document.createElement('textarea');
                textarea.value = textToCopy;
                textarea.style.position = 'fixed';  // Prevent scrolling to the element
                textarea.style.opacity = 0;
                document.body.appendChild(textarea);
                textarea.select();
                
                try {
                    // Execute the copy command
                    const successful = document.execCommand('copy');
                    if (successful) {
                        button.textContent = 'Copied!';
                        setTimeout(() => button.textContent = 'Copy', 2000);
                    } else {
                        console.error('Failed to copy text');
                        alert('Failed to copy to clipboard');
                    }
                } catch (err) {
                    console.error('Error during copy:', err);
                    alert('Failed to copy to clipboard');
                } finally {
                    // Clean up
                    document.body.removeChild(textarea);
                }
            };

            // Try clipboard API first, fall back to execCommand
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(textToCopy)
                    .then(() => {
                        button.textContent = 'Copied!';
                        setTimeout(() => button.textContent = 'Copy', 2000);
                    })
                    .catch(err => {
                        console.error('Clipboard API failed:', err);
                        // Fall back to execCommand approach
                        copyText();
                    });
            } else {
                // Clipboard API not available, use execCommand
                copyText();
            }
        });
    });

    // Portfolio connection handling
    const portfolioSelectionSection = document.getElementById('portfolio-selection-section');
    const apiKeyFormSection = document.getElementById('api-key-form-section');
    const backToPortfolioSelectionBtn = document.getElementById('backToPortfolioSelection');
    const refreshPortfoliosBtn = document.getElementById('refreshPortfoliosBtn');
    
    // Back button handler
    if (backToPortfolioSelectionBtn) {
        backToPortfolioSelectionBtn.addEventListener('click', function() {
            apiKeyFormSection.classList.add('d-none');
            portfolioSelectionSection.classList.remove('d-none');
        });
    }
    
    // Refresh portfolios button
    if (refreshPortfoliosBtn) {
        refreshPortfoliosBtn.addEventListener('click', function() {
            window.location.reload();
        });
    }

    // CSRF token for fetch requests
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    // Create Automation Form
    const createForm = document.getElementById('createAutomationForm');
    if (createForm) {
        createForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            // Disable the submit button to prevent double submission
            const submitButton = this.querySelector('button[type="submit"]');
            submitButton.disabled = true;

            const name = document.getElementById('automationName').value.trim();
            
            if (!name) {
                alert('Please enter an automation name');
                submitButton.disabled = false;
                return;
            }

            try {
                const response = await WebhookManager.fetchWithCSRF('/automation', {
                    method: 'POST',
                    body: JSON.stringify({ name: name })
                });
                
                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Only redirect if we got a successful response
                if (data.automation_id) {
                    window.location.href = `/automation/${data.automation_id}`;
                }
            } catch (error) {
                console.error('Error:', error);
                submitButton.disabled = false;
                alert(`Error creating automation: ${error.message}`);
            }
        });
    }

    // Delete button handler
    const deleteBtn = document.getElementById('deleteAutomationBtn');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', async function() {
            if (confirm('Are you sure you want to delete this automation? This action cannot be undone.')) {
                try {
                    const response = await WebhookManager.fetchWithCSRF(`/automation/${automationId}`, {
                        method: 'DELETE'
                    });
                    
                    const data = await response.json();
                    if (data.error) throw new Error(data.error);
                    window.location.href = '/dashboard';
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error deleting automation: ' + error.message);
                }
            }
        });
    }

    // Inline editing functionality
    const titleContainer = document.getElementById('titleContainer');
    if (titleContainer) {
        const title = document.getElementById('automationTitle');
        const input = document.getElementById('automationTitleInput');
        const editBtn = document.getElementById('editTitleBtn');
        const saveBtn = document.getElementById('saveTitleBtn');

        function enableEditing() {
            title.classList.add('d-none');
            input.classList.remove('d-none');
            editBtn.classList.add('d-none');
            saveBtn.classList.remove('d-none');
            input.focus();
            input.select();
        }

        function disableEditing() {
            title.classList.remove('d-none');
            input.classList.add('d-none');
            editBtn.classList.remove('d-none');
            saveBtn.classList.add('d-none');
            input.value = title.textContent;
        }

        async function saveTitle() {
            const newName = input.value.trim();
            if (!newName) {
                alert('Please enter an automation name');
                return;
            }

            try {
                const response = await WebhookManager.fetchWithCSRF(`/automation/${automationId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ name: newName })
                });
                
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                
                title.textContent = newName;
                disableEditing();
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating automation name: ' + error.message);
                disableEditing();
            }
        }

        editBtn.addEventListener('click', enableEditing);
        saveBtn.addEventListener('click', saveTitle);

        // Handle escape key to cancel editing
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                disableEditing();
            } else if (e.key === 'Enter') {
                saveTitle();
            }
        });

        // Handle clicking outside to cancel editing
        document.addEventListener('click', function(e) {
            if (!titleContainer.contains(e.target) && !input.classList.contains('d-none')) {
                disableEditing();
            }
        }); 
    }

});

// Unified portfolio management code
document.addEventListener('DOMContentLoaded', function() {
    const automationId = document.querySelector('[data-automation-id]')?.dataset.automationId || 
                         '{{ automation.automation_id if automation }}';
    
    if (!automationId) {
        console.log('No automation ID found, skipping portfolio setup');
        return;
    }

    // Cache DOM elements
    const createPortfolioBtn = document.getElementById('createPortfolioBtn');
    const portfolioSelectionSection = document.getElementById('portfolio-selection-section');
    const refreshPortfoliosBtn = document.getElementById('refreshPortfoliosBtn');
    const createPortfolioModal = document.getElementById('createPortfolioModal');
    const createPortfolioForm = document.getElementById('createPortfolioForm');
    
    // Only proceed if we have the necessary elements
    if (!createPortfolioBtn || !portfolioSelectionSection) {
        console.log('Missing required elements, skipping portfolio setup');
        return;
    }
    
    // Initialize Bootstrap modal if available
    let portfolioModal;
    if (createPortfolioModal && typeof bootstrap !== 'undefined') {
        portfolioModal = new bootstrap.Modal(createPortfolioModal);
    }
    
    // Get CSRF token for fetch requests
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
    
    // Utility function for fetch with CSRF
    const fetchWithCSRF = async (url, options = {}) => {
        const defaultOptions = {
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        };
        
        const mergedOptions = { ...defaultOptions, ...options };
        
        if (options.body && typeof options.body === 'object') {
            mergedOptions.body = JSON.stringify(options.body);
        }
        
        return fetch(url, mergedOptions);
    };
    
    /**
     * Displays instruction alert for portfolio setup
     * @param {string} message - The message to display (optional)
     * @param {boolean} hasPortfolios - Whether portfolios exist
     */
    function showPortfolioInstructions(message, hasPortfolios = false) {
        console.log('Showing portfolio instructions alert');
        
        // Remove any existing alerts
        const existingAlerts = document.querySelectorAll('.portfolio-instructions-alert');
        existingAlerts.forEach(alert => alert.remove());
        
        // Create alert container
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-info portfolio-instructions-alert mb-3';
        
        // Set appropriate heading based on whether portfolios exist
        const heading = hasPortfolios 
            ? 'Pick a portfolio or create a new one'
            : 'Create a Portfolio';
            
        // Build alert content
        alertDiv.innerHTML = `
            <h5 class="alert-heading">${heading}</h5>
            <ol>
                <li>Go to <a href="https://www.coinbase.com/advanced-portfolio" target="_blank">https://www.coinbase.com/advanced-portfolio</a></li>
                <li>Click "New Portfolio" and create your portfolio</li>
                <li>Return here, refresh the list, and select your new portfolio</li>
            </ol>
        `;
        
        // Insert the alert at the beginning of the container
        portfolioSelectionSection.insertBefore(alertDiv, portfolioSelectionSection.firstChild);
    }
    
    /**
     * Checks if the user has trading credentials
     */
    async function checkTradingCredentials() {
        console.log('Checking trading credentials');
        
        try {
            const response = await fetchWithCSRF(`/automation/${automationId}/check-trading-credentials`);
            
            if (!response.ok) {
                throw new Error(`Server returned ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('Credential check response:', data);
            
            // Check if non-default portfolios exist
            const portfolioSelect = document.getElementById('portfolio_id');
            
            // Count options that don't contain "Default" in their text
            let nonDefaultOptions = 0;
            if (portfolioSelect) {
                for (let i = 0; i < portfolioSelect.options.length; i++) {
                    const option = portfolioSelect.options[i];
                    // Skip the placeholder option and any option with "Default" in the name
                    if (option.value && option.text.toLowerCase() !== 'default') {
                        nonDefaultOptions++;
                    }
                }
            }
            
            const hasPortfolios = nonDefaultOptions > 0;
            
            if (data.needs_manual_setup) {
                // No trading credentials - show instructions
                createPortfolioBtn.style.display = 'none';
                showPortfolioInstructions(data.message, hasPortfolios);
            } else {
                // Has trading credentials - enable portfolio creation
                createPortfolioBtn.style.display = 'inline-block';
                setupCreatePortfolioButton();
            }
        } catch (error) {
            console.error('Error checking trading credentials:', error);
        }
    }
    
    /**
     * Sets up the create portfolio button click handler
     */
    function setupCreatePortfolioButton() {
        createPortfolioBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            if (portfolioModal) {
                portfolioModal.show();
            } else {
                alert('Portfolio creation is not available at this time. Please refresh the page and try again.');
            }
        });
    }
    
    /**
     * Handle portfolio creation form submission
     */
    function setupPortfolioForm() {
        if (!createPortfolioForm) return;
        
        createPortfolioForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const portfolioName = document.getElementById('portfolioName').value.trim();
            
            if (!portfolioName) {
                alert('Please enter a portfolio name');
                return;
            }
            
            try {
                const response = await fetchWithCSRF(`/automation/${automationId}/create-portfolio`, {
                    method: 'POST',
                    body: { name: portfolioName }
                });
                
                const data = await response.json();
                
                if (data.error) throw new Error(data.error);
                
                // Handle manual setup instruction case
                if (data.needs_manual_setup) {
                    if (portfolioModal) portfolioModal.hide();
                    showPortfolioInstructions(data.message, false);
                    return;
                }
                
                // Handle successful portfolio creation
                if (data.success) {
                    if (portfolioModal) portfolioModal.hide();
                    
                    const select = document.getElementById('portfolio_id');
                    if (select) {
                        const option = new Option(data.portfolio.name, data.portfolio.id);
                        select.add(option);
                        select.value = data.portfolio.id;
                    }
                    
                    alert(`Portfolio "${data.portfolio.name}" created successfully! You can now select it and click "Next" to continue.`);
                }
            } catch (error) {
                console.error('Error creating portfolio:', error);
                alert('Error creating portfolio: ' + error.message);
            }
        });
    }
    
    // Set up refresh button if it exists
    if (refreshPortfoliosBtn) {
        refreshPortfoliosBtn.addEventListener('click', function() {
            window.location.reload();
        });
    }
    
    // Initialize the portfolio management
    checkTradingCredentials();
    setupPortfolioForm();
});
</script>


{% if automation %}
    <script type="text/babel">
        // AutomationLogs component definition
        const AutomationLogs = () => {
            const [logs, setLogs] = React.useState([]);
            const [isLoading, setIsLoading] = React.useState(false);
            const [error, setError] = React.useState(null);
            const [expandedRows, setExpandedRows] = React.useState(new Set());


            const fetchLogs = async () => {
                setIsLoading(true);
                setError(null);
                try {
                    const response = await fetch(`/automation/{{ automation.automation_id }}/logs`);
                    if (!response.ok) {
                        throw new Error('Failed to fetch logs');
                    }
                    const data = await response.json();
                    setLogs(data);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setIsLoading(false);
                }
            };

            const toggleRow = (timestamp) => {
                setExpandedRows(prev => {
                    const next = new Set(prev);
                    if (next.has(timestamp)) {
                        next.delete(timestamp);
                    } else {
                        next.add(timestamp);
                    }
                    return next;
                });
            };

            React.useEffect(() => {
                fetchLogs();
                // Set up auto-refresh every 30 seconds
                const interval = setInterval(fetchLogs, 30000);
                return () => clearInterval(interval);
            }, []);

            return (
                <div className="mt-4">
                    <div className="card">
                        <div className="card-header d-flex justify-content-between align-items-center">
                            <h5 className="mb-0">Webhook Logs</h5>
                            <button 
                                className="btn btn-secondary btn-sm" 
                                onClick={fetchLogs}
                                disabled={isLoading}
                                title="Refresh logs"
                            >
                                {isLoading ? (
                                    <span className="spinner-border spinner-border-sm"></span>
                                ) : (
                                    <i className="fas fa-sync"></i>
                                )}
                            </button>
                        </div>
                        <div className="card-body p-0">
                            <div className="table-responsive">
                                <table className="table mb-0">
                                    <thead>
                                        <tr>
                                            <th className="w-200">Timestamp (UTC)</th>
                                            <th>Payload</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {logs.length === 0 ? (
                                            <tr>
                                                <td colSpan="2" className="text-center py-4">
                                                    No webhook logs found for this automation.
                                                </td>
                                            </tr>
                                        ) : (
                                            logs.map((log) => (
                                                <tr 
                                                    key={log.timestamp}
                                                    onClick={() => toggleRow(log.timestamp)}
                                                    className="webhook-log-row cursor-pointer"
                                                    className="webhook-log-row"
                                                >
                                                    <td>{new Date(log.timestamp).toLocaleString()}</td>
                                                    <td>
                                                        {expandedRows.has(log.timestamp) ? (
                                                            <pre className="mb-0 payload-expanded">
                                                                {JSON.stringify(log.payload, null, 2)}
                                                            </pre>
                                                        ) : (
                                                            <pre className="mb-0 payload-collapsed text-truncate">
                                                                {JSON.stringify(log.payload)}
                                                            </pre>
                                                        )}
                                                    </td>
                                                </tr>
                                            ))
                                        )}
                                    </tbody>
                                </table>
                            </div>
                            {error && (
                                <div className="alert alert-danger m-3" role="alert">
                                    {error}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // Initialize AutomationLogs component
        const container = document.getElementById('automation-logs');
        ReactDOM.render(React.createElement(AutomationLogs), container);
    </script>
{% endif %}
<script>
    // Initialize jQuery UI autocomplete
    $(document).ready(function() {
        const tradingPairInput = $('#trading_pair');
        
        if (tradingPairInput.length) {
            console.log('Initializing jQuery UI autocomplete');
            
            // Access the automation ID, which is needed for the API call
            const automationId = $('[data-automation-id]').data('automationId');
            
            // Define a function to save the trading pair
            function handleTradingPairSelection(productId) {
                console.log('Selected trading pair:', productId);
                
                // Update the input field
                $('#trading_pair').val(productId);
                
                // Update the hidden field
                $('#trading_pair_id').val(productId);
                
                // Make the API call manually
                fetch(`/automation/${automationId}/trading-pair`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')
                    },
                    body: JSON.stringify({ trading_pair: productId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Trading pair saved successfully');
                        
                        // Show the TradingView setup section and hide the alert
                        $('#tradingview-setup-section').show();
                        $('#no-trading-pair-alert').hide();
                        
                        // Update the template with the new trading pair
                        const templateCode = $('#webhook-template-code');
                        if (templateCode.length) {
                            const template = templateCode.text();
                            const updatedTemplate = template.replace(/"ticker": "[^"]*"/, `"ticker": "${productId}"`);
                            templateCode.text(updatedTemplate);
                        }
                    } else if (data.error) {
                        console.error('Error saving trading pair:', data.error);
                        alert(`Error saving trading pair: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('Error saving trading pair:', error);
                    alert('Error saving trading pair. Please try again.');
                });
            }
            
            // Fetch trading pairs
            fetch('/api/coinbase/trading-pairs')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.trading_pairs && data.trading_pairs.length > 0) {
                        console.log(`Loaded ${data.trading_pairs.length} trading pairs for autocomplete`);
                        
                        // Initialize autocomplete
                        tradingPairInput.autocomplete({
                            source: function(request, response) {
                                const term = request.term.toLowerCase();
                                const matches = data.trading_pairs.filter(pair => {
                                    return (pair.product_id && pair.product_id.toLowerCase().includes(term)) ||
                                        (pair.base_currency && pair.base_currency.toLowerCase().includes(term)) ||
                                        (pair.quote_currency && pair.quote_currency.toLowerCase().includes(term));
                                });
                                response(matches.slice(0, 15).map(pair => {
                                    return {
                                        label: pair.product_id,
                                        value: pair.product_id
                                    };
                                }));
                            },
                            minLength: 2,
                            select: function(event, ui) {
                                // Call our handler function
                                handleTradingPairSelection(ui.item.value);
                                return true;
                            }
                        });
                    }
                })
                .catch(error => console.error('Error fetching trading pairs:', error));
        }
    });
</script>
{% endblock %}