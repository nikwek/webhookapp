{% extends "base.html" %}

{% block title %}Dashboard - Webhook Manager{% endblock title %}

{% block styles %}
<style>
    /* Automation styles */
    .automation-row {
        border-bottom: 1px solid #dee2e6;
        background-color: #fff;
    }

    .automation-header {
        padding: 0.75rem 1rem;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .automation-header:hover {
        background-color: #f8f9fa;
    }

    .automation-details {
        padding: 1rem;
        background-color: #f8f9fa;
        border-top: 1px solid #dee2e6;
    }

    .automation-row.inactive {
        background-color: #f8f9fa;
    }

    .automation-row:first-child {
        border-top: 1px solid #dee2e6;
    }

    .automation-row:last-child {
        border-bottom: 1px solid #dee2e6;
    }

    /* Container styles */
    #automations-container {
        border-left: 1px solid #dee2e6;
        border-right: 1px solid #dee2e6;
    }

    /* Webhook type styles */
    .webhook-type-buy { 
        background-color: rgba(40, 167, 69, 0.1);
        border-left: 4px solid rgba(40, 167, 69, 0.8);
    }
    .webhook-type-sell { 
        background-color: rgba(220, 53, 69, 0.1);
        border-left: 4px solid rgba(220, 53, 69, 0.8);
    }
    .webhook-type-other { 
        background-color: rgba(108, 117, 125, 0.1);
        border-left: 4px solid rgba(108, 117, 125, 0.8);
    }
    
    .table-responsive {
        overflow-x: auto;
        max-width: 100%;
    }

    #webhook-table {
        width: 100%;
        table-layout: fixed;
    }

    /* Timestamp column - fixed width */
    #webhook-table th:first-child,
    #webhook-table td:first-child {
        width: 180px;
        min-width: 180px;
        white-space: nowrap;
    }

    /* Automation name column - dynamic but capped */
    #webhook-table th:nth-child(2),
    #webhook-table td:nth-child(2) {
        width: 250px;          /* Changed from auto to fixed width */
        min-width: 100px;      /* Added minimum width */
        max-width: 250px;
        overflow-wrap: break-word;
        word-wrap: break-word; /* Added for better browser compatibility */
        word-break: normal;    /* Changed from break-all to normal for better readability */
        hyphens: auto;         /* Added to help with word breaking */
    }

    /* Payload column - takes remaining space */
    #webhook-table th:nth-child(3),
    #webhook-table td:nth-child(3) {
        width: auto;
    }

    /* Action column - fixed width */
    #webhook-table th:last-child,
    #webhook-table td:last-child {
        width: 100px;
        min-width: 100px;
        white-space: nowrap;
        text-align: center;
    }
    
    .payload-container {
        position: relative;
        width: 100%;
    }
    
    .json-compact, .json-pretty {
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
        max-width: 100%;
    }
    
    .json-pretty {
        display: none;
    }

    th.sortable {
        cursor: pointer;
    }

    th.sortable:hover {
        background-color: #f8f9fa;
    }

    th.sortable i {
        margin-left: 5px;
    }

</style>
{% endblock styles %}

{% block content %}
<div class="container mt-4">
    <!-- Automations Section -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0">Automations</h4>
            <button id="createAutomationBtn" class="btn btn-secondary">Create New Automation</button>
        </div>
        <div id="automations-container">
                {% for automation in automations %}
                <div class="automation-row {% if not automation.is_active %}inactive{% endif %}" 
                     data-automation-id="{{ automation.automation_id }}">
                    <div class="automation-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>
                                <i class="fas fa-chevron-right chevron-icon me-2"></i>
                                {{ automation.name }}
                            </span>
                            <div>
                                <button class="btn btn-sm btn-secondary edit-automation-name" 
                                        data-automation-id="{{ automation.automation_id }}" 
                                        data-automation-name="{{ automation.name }}">
                                    Edit
                                </button>
                                <button class="btn btn-sm status-button {% if automation.is_active %}btn-success{% else %}btn-danger{% endif %}" 
                                        data-automation-id="{{ automation.automation_id }}" 
                                        data-is-active="{{ automation.is_active | string | lower }}"> 
                                    {{ "Active" if automation.is_active else "Inactive" }}
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="automation-details" style="display: none;">
                        <div class="mb-3">
                            <strong>Webhook URL:</strong>
                            <input type="text" class="form-control" value="{{ automation.webhook_url }}" readonly>
                        </div>
                        <div class="mb-3">
                            <strong>Template JSON:</strong>
                            <pre class="bg-light p-3 mb-2"><code id="template-{{ automation.automation_id }}">{{ automation.template | default({
                                "action": "{{strategy.order.action}}",
                                "ticker": "{{ticker}}",
                                "order_size": "100%",
                                "position_size": "{{strategy.position_size}}",
                                "schema": "2",
                                "timestamp": "{{time}}"
                            }) | tojson(indent=2) }}</code></pre>
                            <button class="btn btn-sm btn-secondary copy-button" 
                                    data-template-id="template-{{ automation.automation_id }}">
                                Copy
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Webhook Logs Section -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0">Webhook Logs</h4>
            <div>
                <input type="text" id="searchInput" class="form-control form-control-sm d-inline-block mr-2" 
                       placeholder="Search logs..." style="width: 200px;">
                <button id="exportButton" class="btn btn-secondary btn-sm">
                    <i class="fas fa-download me-1"></i>Export to CSV
                </button>
            </div>
        </div>
        <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table" id="webhook-table">
                <thead>
                    <tr>
                        <th class="sortable" data-sort="timestamp">Timestamp (UTC) <i class="fas fa-sort"></i></th>
                        <th class="sortable" data-sort="automation">Automation <i class="fas fa-sort"></i></th>
                        <th>Payload</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="logs">
                    {% for log in logs %}
                    <tr class="webhook-type-{{ log.payload.action|lower|default('other') }}">
                        <td>{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                        <td>{{ log.automation.name if log.automation else 'N/A' }}</td>
                        <td>
                            <div class="payload-container">
                                <pre class="json-compact mb-0">{{ log.payload | tojson }}</pre>
                                <pre class="json-pretty mb-0" style="display: none;">{{ log.payload | tojson(indent=2) }}</pre>
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-secondary toggle-json">Expand</button>
                            <button class="btn btn-sm btn-secondary copy-json" style="display: none;">Copy</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal for creating new automation -->
<div class="modal fade" id="createAutomationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Automation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createAutomationForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="automationName" class="form-label">Automation Name</label>
                        <input type="text" class="form-control" id="automationName" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal for activation/deactivation -->
<div class="modal fade" id="automationStatusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Content will be set dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmStatusChange">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for editing automation -->
<div class="modal fade" id="editAutomationModal" tabindex="-1" aria-labelledby="editAutomationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editAutomationModalLabel">Edit Automation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editAutomationForm">
                    <div class="mb-3">
                        <label for="editAutomationName" class="form-label">Automation Name</label>
                        <input type="text" class="form-control" id="editAutomationName" name="automationName" required>
                        <input type="hidden" id="editAutomationId" name="automationId" value="">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="deleteAutomation">Delete Automation</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveAutomationChanges">Save Changes</button>
            </div>
        </div>
    </div>
</div>

{% include 'partials/_dashboard_modals.html' %}
{% endblock content %}

{% block scripts %}
<script>

// Initialize SSE connection
let evtSource = new EventSource('/webhook-stream');

evtSource.onmessage = function(event) {
    const logs = JSON.parse(event.data);
    const logsTable = document.querySelector('#logs');
    if (!logsTable || !logs.length) return;

    // Update logs table
    logsTable.innerHTML = logs.map(log => `
        <tr class="webhook-type-${(log.payload.action || '').toLowerCase() || 'other'}">
            <td>${new Date(log.timestamp).toLocaleString()}</td>
            <td>${log.automation_name || 'N/A'}</td>
            <td>
                <div class="payload-container">
                    <pre class="json-compact mb-0">${JSON.stringify(log.payload)}</pre>
                    <pre class="json-pretty mb-0" style="display:none">${JSON.stringify(log.payload, null, 2)}</pre>
                    <button class="btn btn-sm btn-secondary toggle-json">Expand</button>
                </div>
            </td>
        </tr>
    `).join('');

    // Reinitialize event listeners
    WebhookManager.initializeEventListeners();
};

// Handle page visibility
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        evtSource.close();
    } else {
        evtSource = new EventSource('/webhook-stream');
    }
});

// Clean up on page unload
window.addEventListener('beforeunload', () => {
    evtSource.close();
});

// Copy button handler
document.querySelectorAll('.copy-button').forEach(button => {
    button.addEventListener('click', function() {
        const templateId = this.dataset.templateId;
        const template = document.getElementById(templateId);
        const textToCopy = template.textContent.trim();

        // Try using Clipboard API first
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(textToCopy)
                .then(() => {
                    this.textContent = 'Copied!';
                    setTimeout(() => this.textContent = 'Copy', 2000);
                })
                .catch(err => {
                    console.error('Failed to copy:', err);
                    fallbackCopyText(textToCopy, this);
                });
        } else {
            // Fallback for browsers that don't support Clipboard API
            fallbackCopyText(textToCopy, this);
        }
    });
});

// Fallback copy function using textarea
function fallbackCopyText(text, button) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';  // Avoid scrolling to bottom
    textArea.style.opacity = '0';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();

    try {
        document.execCommand('copy');
        button.textContent = 'Copied!';
        setTimeout(() => button.textContent = 'Copy', 2000);
    } catch (err) {
        console.error('Fallback copy failed:', err);
        button.textContent = 'Copy failed';
        setTimeout(() => button.textContent = 'Copy', 2000);
    }

    document.body.removeChild(textArea);
}

// Search functionality
const searchInput = document.getElementById('searchInput');
if (searchInput) {
    searchInput.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        document.querySelectorAll('#logs tr').forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? '' : 'none';
        });
    });
}

// Export to CSV functionality
document.addEventListener('DOMContentLoaded', function() {
    const exportButton = document.getElementById('exportButton');
    if (exportButton) {
        exportButton.addEventListener('click', function() {
            console.log('Export button clicked');
            const table = document.getElementById('webhook-table');
            if (!table) {
                console.error('Webhook table not found');
                return;
            }
            const rows = table.querySelectorAll('tbody tr');
            console.log(`Found ${rows.length} rows`);

            let csvContent = "data:text/csv;charset=utf-8,";

            // Collect all unique keys from payloads
            const allKeys = new Set();
            rows.forEach(row => {
                const payloadElement = row.querySelector('.json-compact');
                if (payloadElement) {
                    try {
                        const payload = JSON.parse(payloadElement.textContent);
                        Object.keys(payload).forEach(key => allKeys.add(key));
                    } catch (error) {
                        console.error('Error parsing payload:', error);
                    }
                }
            });
            console.log('Unique keys:', Array.from(allKeys));

            // Add headers
            csvContent += `"Timestamp (UTC)","Automation",${Array.from(allKeys).map(key => `"${key}"`).join(',')}\n`;

            // Add row data
            rows.forEach(row => {
                const timestamp = row.cells[0].textContent;
                const automation = row.cells[1].textContent;
                const payloadElement = row.querySelector('.json-compact');
                let payload = {};
                if (payloadElement) {
                    try {
                        payload = JSON.parse(payloadElement.textContent);
                    } catch (error) {
                        console.error('Error parsing payload:', error);
                    }
                }

                let rowData = `"${timestamp}","${automation}",`;
                allKeys.forEach(key => {
                    const value = payload[key] !== undefined ? payload[key] : '';
                    rowData += `"${String(value).replace(/"/g, '""')}",`;
                });

                csvContent += rowData.slice(0, -1) + '\n'; // Remove trailing comma and add newline
            });

            console.log('CSV content generated');

            // Create download link and trigger download
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "webhook_logs.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            console.log('Download triggered');
        });
    } else {
        console.error('Export button not found');
    }
});

// Function to handle sorting
function sortTable(column) {
    const table = document.getElementById('webhook-table');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));

    const sortOrder = table.getAttribute('data-sort-order') === 'asc' ? 'desc' : 'asc';
    table.setAttribute('data-sort-order', sortOrder);

    rows.sort((a, b) => {
        let aValue = a.cells[column === 'timestamp' ? 0 : 1].textContent.trim();
        let bValue = b.cells[column === 'timestamp' ? 0 : 1].textContent.trim();

        if (column === 'timestamp') {
            aValue = new Date(aValue);
            bValue = new Date(bValue);
        }

        if (aValue < bValue) return sortOrder === 'asc' ? -1 : 1;
        if (aValue > bValue) return sortOrder === 'asc' ? 1 : -1;
        return 0;
    });

    rows.forEach(row => tbody.appendChild(row));

    // Update sort icons
    table.querySelectorAll('th.sortable i').forEach(icon => {
        icon.className = 'fas fa-sort';
    });
    const sortedHeader = table.querySelector(`th[data-sort="${column}"] i`);
    sortedHeader.className = `fas fa-sort-${sortOrder === 'asc' ? 'up' : 'down'}`;
}

// Add event listeners for sorting
document.querySelectorAll('#webhook-table th.sortable').forEach(th => {
    th.addEventListener('click', () => {
        const column = th.getAttribute('data-sort');
        sortTable(column);
    });
});


</script>
{% endblock scripts %}