{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mt-4 mb-4" data-strategy-id="{{ strategy.id }}">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center">
            <h1 class="mb-0 me-2">Strategy:</h1>
            <div id="strategyNameContainer" class="d-flex align-items-center">
                <span id="strategyNameDisplay" class="fw-normal h1 mb-0">{{ strategy.name }}</span>
                <form id="editNameForm" action="{{ url_for('exchange.edit_strategy_name', exchange_id=exchange_id, strategy_id=strategy.id) }}" method="POST" class="d-inline d-none">
                    <input type="text"
                           id="strategyNameInput"
                           name="new_strategy_name"
                           class="form-control form-control-sm"
                           value="{{ strategy.name }}"
                           style="width: auto; vertical-align: middle;"
                           required>
                </form>
                <button class="btn btn-link p-0 ms-2 text-secondary opacity-50 hover-opacity-100" id="editNameBtn" title="Edit Strategy Name" style="transition: opacity 0.2s;">
                    <i class="fas fa-pencil-alt fa-sm"></i>
                </button>
                <button type="button" class="btn btn-link p-0 ms-2 d-none" id="saveNameBtn" title="Save Name">
                    <i class="fas fa-check text-success fa-lg"></i>
                </button>
                <button type="button" class="btn btn-link p-0 ms-1 d-none" id="cancelNameBtn" title="Cancel Edit">
                    <i class="fas fa-times text-danger fa-lg"></i>
                </button>
            </div>
        </div>
        <div>
            <a href="{{ url_for('exchange.view_exchange', exchange_id=exchange_id) }}" class="btn btn-outline-secondary me-2">
                <i class="fas fa-arrow-left me-2"></i>Back to {{ current_exchange_display_name }}
            </a>
            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteStrategyModal">
                <i class="fas fa-trash-alt me-1"></i> Delete Strategy
            </button>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Strategy Details</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <dl class="row">
                        <dt class="col-sm-4">Name:</dt>
                        <dd class="col-sm-8">{{ strategy.name }}</dd>

                        <dt class="col-sm-4">Trading Pair:</dt>
                        <dd class="col-sm-8">{{ strategy.trading_pair }}</dd>

                        <dt class="col-sm-4">Exchange:</dt>
                        <dd class="col-sm-8">{{ current_exchange_display_name }}</dd>

                        <dt class="col-sm-4">Status:</dt>
                        <dd class="col-sm-8">
                            {% if strategy.is_active %}
                                <span class="badge bg-success">Active</span>
                            {% else %}
                                <span class="badge bg-secondary">Inactive</span>
                            {% endif %}
                            <form method="POST" action="{{ url_for('exchange.toggle_strategy_active', exchange_id=exchange_id, strategy_id=strategy.id) }}" class="d-inline ms-2">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                {% if strategy.is_active %}
                                <button type="submit" class="btn btn-sm btn-outline-secondary">Pause</button>
                                {% else %}
                                <button type="submit" class="btn btn-sm btn-outline-success">Resume</button>
                                {% endif %}
                            </form>
                        </dd>
                    </dl>
                </div>
                <div class="col-md-6">
                    <dl class="row">
                        <dt class="col-sm-5">Allocated Base Asset:</dt>
                        <dd class="col-sm-7">{{ (strategy.allocated_base_asset_quantity | float) | round(8) }} {{ strategy.base_asset_symbol }}</dd>

                        <dt class="col-sm-5">Allocated Quote Asset:</dt>
                        <dd class="col-sm-7">{{ (strategy.allocated_quote_asset_quantity | float) | round(8) }} {{ strategy.quote_asset_symbol }}</dd>

                        <dt class="col-sm-5">Est. Total Value (USD):</dt>
                        <dd class="col-sm-7" id="strategyTotalValue">–</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>



    <!-- Webhook Details Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Webhook Details</h5>
        </div>
        <div class="card-body">
            <dl class="row mb-0">
                <dt class="col-sm-3">Webhook URL:</dt>
                <dd class="col-sm-9 mb-3">
                    <div class="input-group">
                        <input type="text" class="form-control form-control-sm" value="{{ application_url.rstrip('/') }}{{ url_for('webhook.webhook', automation_id=strategy.webhook_id) }}" id="webhookUrl" readonly>
                        <button class="btn btn-outline-secondary btn-sm" type="button" onclick="copyToClipboard('webhookUrl', this)" title="Copy Webhook URL">
                            <i class="fas fa-copy me-1"></i>Copy URL
                        </button>
                    </div>
                </dd>

                <dt class="col-sm-3">Webhook Template:</dt>
                <dd class="col-sm-9">
                    {% if strategy.webhook_template %}
                        <div class="position-relative">
                            <pre class="mb-0" id="webhookTemplatePre"><code id="webhookTemplateCode">{{ strategy.webhook_template }}</code></pre>
                            <button class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 mt-1 me-1" type="button" onclick="copyToClipboard('webhookTemplateCode', this, true)" title="Copy Webhook Template">
                                <i class="fas fa-copy me-1"></i>Copy Template
                            </button>
                        </div>
                    {% else %}
                        <span class="text-muted">Not set. Create a new strategy to generate a default template.</span>
                    {% endif %}
                </dd>
            </dl>
        </div>
    </div>

    <!-- Performance Chart -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Performance</h5>
        </div>
        <div class="card-body">
            <canvas id="performanceChart" height="120"></canvas>
        </div>
    </div>

    <!-- Webhook Logs -->
    <div id="strategy-logs-container" data-strategy-name="{{ strategy.name }}" data-exchange-slug="{{ exchange_id }}" data-strategy-id="{{ strategy.id }}"></div>

</div>

<!-- Delete Strategy Modal -->
<div class="modal fade" id="deleteStrategyModal" tabindex="-1" aria-labelledby="deleteStrategyModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteStrategyModalLabel">Confirm Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete the strategy "<strong>{{ strategy.name }}</strong>"?</p>
        <p class="text-danger">This action cannot be undone. Any assets allocated to this strategy will be returned to your main account balance.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form action="{{ url_for('exchange.delete_trading_strategy', exchange_id=exchange_id, strategy_id=strategy.id) }}" method="POST">
          <button type="submit" class="btn btn-danger">Delete Strategy</button>
        </form>
      </div>
    </div>
  </div>
</div>

{# React component for logs - needs to be wrapped in raw to prevent Jinja from parsing JSX #}
{% raw %}
<script type="text/babel">

    const UnifiedWebhookLogs = ({ strategyName, strategyId, exchangeName }) => {
        const [logs, setLogs] = React.useState([]);
        const [isLoading, setIsLoading] = React.useState(false);
        const [error, setError] = React.useState(null);
        const [expandedRows, setExpandedRows] = React.useState(new Set());
        const [currentPage, setCurrentPage] = React.useState(1);
        const [totalPages, setTotalPages] = React.useState(1);
        const [totalLogs, setTotalLogs] = React.useState(0);
        const [itemsPerPage, setItemsPerPage] = React.useState(20);
        const [searchTerm, setSearchTerm] = React.useState("");

        React.useEffect(() => {
            fetchLogs();
        }, [strategyName, strategyId, exchangeName, currentPage, itemsPerPage, searchTerm]);

        const fetchLogs = async () => {
            setIsLoading(true);
            try {
                let url;
                if (strategyId) {
                    url = `/api/strategy/${strategyId}/logs?page=${currentPage}&itemsPerPage=${itemsPerPage}&search=${searchTerm}`;
                } else {
                    url = `/api/logs?strategy=${encodeURIComponent(strategyName)}&exchange=${encodeURIComponent(exchangeName)}&page=${currentPage}&itemsPerPage=${itemsPerPage}&search=${encodeURIComponent(searchTerm)}`;
                }
                const response = await fetch(url);
                const data = await response.json();
                console.log("Fetched Logs:", data.logs); // Log the entire logs array
                data.logs.forEach(log => {
                    console.log(`Log ID: ${log.id}, Exchange: ${log.exchange_name}, Strategy: ${log.strategy_name}`); // Log each entry's details
                });
                setLogs(data.logs);
                setTotalPages(data.totalPages);
                setTotalLogs(data.totalLogs);
            } catch (err) {
                setError("Failed to load logs.");
            } finally {
                setIsLoading(false);
            }
        };

        const toggleRow = (id) => {
            const newExpandedRows = new Set(expandedRows);
            if (newExpandedRows.has(id)) {
                newExpandedRows.delete(id);
            } else {
                newExpandedRows.add(id);
            }
            setExpandedRows(newExpandedRows);
        };

        return (
            <div className="card mb-4">
                <div className="card-header d-flex justify-content-between align-items-center bg-transparent border-bottom">
                    <h5 className="mb-0">Activity</h5>
                    <button className="btn btn-secondary btn-sm" onClick={fetchLogs} disabled={isLoading} title="Refresh Logs">
                        {isLoading ? (
                            <><span className="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...</>
                        ) : (
                            <><i className="fas fa-sync-alt me-1"></i> Refresh</>
                        )}
                    </button>
                </div>
                <div className="input-group px-3 py-2 border-bottom">
                    <span className="input-group-text bg-light border-light">
                        <i className="fas fa-search text-muted"></i>
                    </span>
                    <input 
                        type="text" 
                        className="form-control bg-light border-light" 
                        placeholder="Search logs..." 
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                    />
                </div>
                <div className="card-body p-0 table-responsive">
                    <table className="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th className="text-nowrap" style={{width: "200px"}}>Timestamp (UTC)</th>
                                <th style={{width: "15%"}}>Exchange</th>
                                <th style={{width: "25%"}}>Account</th>
                                <th>Information</th>
                            </tr>
                        </thead>
                        <tbody>
                            {logs.map((log) => (
                                <React.Fragment key={log.id}>
                                    <tr onClick={() => toggleRow(log.id)} style={{cursor: 'pointer'}}>
                                        <td className="text-nowrap">
                                            {new Date(log.timestamp).toLocaleString('en-GB', { timeZone: 'UTC', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }).replace(',', '')}
                                            <i className={`fas ${expandedRows.has(log.id) ? 'fa-chevron-down' : 'fa-chevron-right'} fa-xs ms-2 text-muted`}></i>
                                        </td>
                                        <td>{log.exchange_name || "Unknown"}</td> {/* Ensure this line accesses the correct field */}
                                        <td>{log.account_name || log.strategy_name || "Unknown"}</td> {/* Ensure this line accesses the correct field */}
                                        <td>
                                                <div className="d-flex justify-content-between">
                                                    <div>
                                                        {log.action && (
                                                            <span className={`badge ${log.action.toLowerCase() === 'buy' ? 'bg-success' : log.action.toLowerCase() === 'transfer' ? 'bg-warning text-dark' : 'bg-danger'} me-2`}>
                                                                {log.action.toUpperCase()}
                                                            </span>
                                                        )}
                                                        <strong>{log.ticker || log.trading_pair || ''}</strong>
                                                        {log.message && <span className="ms-2 text-muted">{log.message}</span>}
                                                    </div>
                                                    <div>
                                                        {log.status && (
                                                            <span className={`badge ${
                                                                log.status.toLowerCase() === 'success' ? 'bg-success' :
                                                                log.status.toLowerCase() === 'error' ? 'bg-danger' :
                                                                log.status.toLowerCase() === 'filled' ? 'bg-primary' : 'bg-secondary'
                                                            }`}>
                                                                {log.status.charAt(0).toUpperCase() + log.status.slice(1).toLowerCase()}
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                            </td>
                                    </tr>
                                    {expandedRows.has(log.id) && (
                                        <tr>
                                            <td colSpan="4" className="p-0">
                                                <div className="p-3 bg-light border-top border-bottom">
                                                    {log.payload && <div className="mb-2"><h6 className="mb-1 small text-muted fw-bold">Webhook Payload:</h6><pre className="bg-white p-2 rounded small mb-0 border" style={{maxHeight: '200px', overflowY: 'auto'}}><code>{formatJsonDisplay(log.payload)}</code></pre></div>}
                                                    {log.raw_response && <div className="mb-0"><h6 className="mb-1 small text-muted fw-bold">Processing Response / Info:</h6><pre className="bg-white p-2 rounded small mb-0 border" style={{maxHeight: '200px', overflowY: 'auto'}}><code>{formatJsonDisplay(log.raw_response)}</code></pre></div>}
                                                    {!log.payload && !log.raw_response && <pre className="bg-white p-2 rounded small mb-0 border" style={{maxHeight: '200px', overflowY: 'auto'}}><code>{formatJsonDisplay(log)}</code></pre>}
                                                </div>
                                            </td>
                                        </tr>
                                    )}
                                </React.Fragment>
                            ))}
                        </tbody>
                    </table>
                    {error && <div className="alert alert-danger m-3 mb-0" role="alert">Error: {error}</div>}
                </div>
                {totalLogs > 0 && (
                    <div className="card-footer d-flex justify-content-between align-items-center">
                        <div>
                            <span className="me-2 small text-muted">Show:</span>
                            <select className="form-select form-select-sm d-inline-block" style={{width: "auto"}} value={itemsPerPage} onChange={(e) => setItemsPerPage(e.target.value)} disabled={isLoading}>
                                {[10, 20, 50].map(size => (
                                    <option key={size} value={size}>{size}</option>
                                ))}
                            </select>
                        </div>
                        <div>
                            <span className="me-2 small text-muted">Page:</span>
                            <select className="form-select form-select-sm d-inline-block" style={{width: "auto"}} value={currentPage} onChange={(e) => setCurrentPage(e.target.value)} disabled={isLoading}>
                                {Array.from({ length: totalPages }, (_, i) => i + 1).map(page => (
                                    <option key={page} value={page}>{page}</option>
                                ))}
                            </select>
                        </div>
                    </div>
                )}
            </div>
        );
    };

    // Expose globally
    window.UnifiedWebhookLogs = UnifiedWebhookLogs;

    function mountStrategyLogs() {
        const container = document.getElementById('strategy-logs-container');
        if (!container) return;
        const strategyName = container.dataset.strategyName || "";
        const strategyId = parseInt(container.dataset.strategyId || "", 10) || null;
        const exchangeSlug = container.dataset.exchangeSlug || "";
        ReactDOM.render(
            <UnifiedWebhookLogs strategyName={strategyName} strategyId={strategyId} exchangeName={exchangeSlug} />,
            container
        );
    }
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', mountStrategyLogs);
    } else {
        mountStrategyLogs();
    }

</script>
{% endraw %}


<!-- Delete Strategy Modal -->
<div class="modal fade" id="deleteStrategyModal" tabindex="-1" aria-labelledby="deleteStrategyModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteStrategyModalLabel">Confirm Strategy Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete the strategy "<strong>{{ strategy.name }}</strong>"?</p>
        <p class="text-danger"><strong>Warning:</strong> This action cannot be undone. Any allocated assets will be returned to your main account balance.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form action="{{ url_for('exchange.delete_trading_strategy', exchange_id=exchange_id, strategy_id=strategy.id) }}" method="POST" class="d-inline">
          <button type="submit" class="btn btn-danger">Yes, Delete Strategy</button>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Edit/save/cancel for strategy name
    const display = document.getElementById('strategyNameDisplay');
    const form = document.getElementById('editNameForm');
    const input = document.getElementById('strategyNameInput');
    const editBtn = document.getElementById('editNameBtn');
    const saveBtn = document.getElementById('saveNameBtn');
    const cancelBtn = document.getElementById('cancelNameBtn');
    const originalName = display.textContent;

    editBtn.addEventListener('click', () => {
        display.classList.add('d-none');
        editBtn.classList.add('d-none');
        form.classList.remove('d-none');
        saveBtn.classList.remove('d-none');
        cancelBtn.classList.remove('d-none');
        input.focus();
        input.select();
    });

    cancelBtn.addEventListener('click', () => {
        display.classList.remove('d-none');
        editBtn.classList.remove('d-none');
        form.classList.add('d-none');
        saveBtn.classList.add('d-none');
        cancelBtn.classList.add('d-none');
        input.value = originalName;
    });

    saveBtn.addEventListener('click', () => {
        form.requestSubmit();
    });
});

function copyToClipboard(elementId, buttonElement, isCode = false) {
    const textToCopy = isCode 
        ? document.getElementById(elementId).innerText 
        : document.getElementById(elementId).value;

    const showSuccess = () => {
        const originalIcon = buttonElement.innerHTML;
        const originalTitle = buttonElement.title;
        buttonElement.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
        buttonElement.classList.remove('btn-outline-secondary');
        buttonElement.classList.add('btn-success');
        buttonElement.title = 'Copied to clipboard';
        setTimeout(() => {
            buttonElement.innerHTML = originalIcon;
            buttonElement.classList.remove('btn-success');
            buttonElement.classList.add('btn-outline-secondary');
            buttonElement.title = originalTitle;
        }, 2000);
    };

    if (navigator.clipboard && window.isSecureContext) {
        // Use modern clipboard API in secure contexts
        navigator.clipboard.writeText(textToCopy).then(showSuccess).catch(err => {
            console.error('Failed to copy with modern API: ', err);
            alert('Failed to copy to clipboard.');
        });
    } else {
        // Fallback for non-secure contexts or older browsers
        const textArea = document.createElement("textarea");
        textArea.value = textToCopy;
        textArea.style.position = "fixed"; // Prevent scrolling to bottom of page in MS Edge.
        textArea.style.top = "0";
        textArea.style.left = "0";
        textArea.style.opacity = "0";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showSuccess();
            } else {
                console.error('Fallback copy was unsuccessful');
                alert('Failed to copy to clipboard.');
            }
        } catch (err) {
            console.error('Failed to copy with fallback: ', err);
            alert('Failed to copy to clipboard.');
        }
        document.body.removeChild(textArea);
    }
}
</script>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    const canvas = document.getElementById('performanceChart');
    if (!canvas) return;
    try {
        const stratId = {{ strategy.id }};
        const resp = await fetch(`/api/strategy/${stratId}/performance?days=90`);
        const json = await resp.json();
        const labels = json.data.map(pt => (new Date(pt.timestamp)).toLocaleDateString());
        const rawVals = json.data.map(pt => pt.value_usd);
        const latestVal = rawVals.length ? rawVals[rawVals.length - 1] : 0;
        const base = rawVals.length ? rawVals[0] : 0;
        const vals = rawVals.map(v => parseFloat((v - base).toFixed(2)));
        // Update est total value line
        const valElem = document.getElementById('strategyTotalValue'); if (valElem) valElem.textContent = '$' + latestVal.toFixed(2);
        // Determine symmetric y-axis range so 0 is centered
        const maxAbs = vals.reduce((m, v) => Math.max(m, Math.abs(v)), 0);
        const RANGE = maxAbs > 0 ? maxAbs : 1;
        if (!labels.length) {
            canvas.parentElement.innerHTML = '<p class="text-muted mb-0">No performance data yet.</p>';
            return;
        }
        new Chart(canvas, {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: 'Δ USD Value',
                    data: vals,
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13,110,253,0.1)',
                    fill: true,
                    tension: 0.3,
                    pointRadius: 2
                }]
            },
            options: {
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        min: -RANGE,
                            max: RANGE,
                        ticks: {
                            callback: v => (v >= 0 ? '+' : '') + '$' + v.toFixed(2)
                        }
                    }
                }
            }
        });
    } catch (err) {
        console.error('Performance chart error', err);
        canvas.parentElement.innerHTML = '<p class="text-danger mb-0">Failed to load performance data.</p>';
    }
});
</script>

{% endblock %}
